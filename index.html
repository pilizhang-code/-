<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验室仪器管理系统</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@4.0.0/dist/realtime-min.js"></script>
    <!-- LeanCloud配置 -->
    <script src="js/leancloud-config.js"></script>
    <!-- LeanCloud数据同步模块 -->
    <script src="js/leancloud.js"></script>
    <!-- 自定义 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 300ms;
            }
            .card-hover {
                @apply hover:shadow-lg hover:-translate-y-1 transition-all;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-all;
            }
            .btn-secondary {
                @apply bg-secondary text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-all;
            }
            .btn-success {
                @apply bg-success text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-all;
            }
            .btn-warning {
                @apply bg-warning text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-all;
            }
            .btn-danger {
                @apply bg-danger text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-all;
            }
            .input-field {
                @apply border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .status-badge {
                @apply inline-block w-3 h-3 rounded-full mr-2;
            }
            .status-normal {
                @apply bg-success;
            }
            .status-maintenance {
                @apply bg-warning;
            }
            .status-disabled {
                @apply bg-danger;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- 登录页面 -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/3de15648cd4848b08d6bac7dacbc3fc3~tplv-a9rns2rl98-image.image?rcl=2025102409444359CDEB0476A3A6A2B278&amp;rk3s=8e244e95&amp;rrcfp=f06b921b&amp;x-expires=1763862346&amp;x-signature=ujvMtVBJ8yiImXi6jjesvNzQbKc%3D" alt="实验室仪器管理系统" class="h-24 mx-auto mb-4">
                <h1 class="text-2xl font-bold text-gray-800">实验室仪器管理系统</h1>
                <p class="text-gray-600">请登录以访问系统</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                    <input type="text" id="username" name="username" class="input-field w-full" placeholder="请输入用户名" required="">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="password" name="password" class="input-field w-full" placeholder="请输入密码" required="">
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">记住我</label>
                    </div>
                    <a href="#" id="forgot-password" class="text-sm text-primary hover:text-primary-dark">修改密码</a>
                </div>
                <div>
                    <button type="submit" class="w-full btn-primary flex justify-center items-center">
                        <i class="fa fa-sign-in mr-2"></i> 登录
                    </button>
                </div>
            </form>
            <div id="login-message" class="mt-4 text-center text-red-500 hidden"></div>
        </div>
    </div>

    <!-- 修改密码弹窗 -->
    <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">修改密码</h2>
                <button id="close-password-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="change-password-form" class="space-y-6">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">当前密码</label>
                    <input type="password" id="current-password" name="current-password" class="input-field w-full" placeholder="请输入当前密码" required="">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                    <input type="password" id="new-password" name="new-password" class="input-field w-full" placeholder="请输入新密码" required="">
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
                    <input type="password" id="confirm-password" name="confirm-password" class="input-field w-full" placeholder="请再次输入新密码" required="">
                </div>
                <div>
                    <button type="submit" class="w-full btn-primary flex justify-center items-center">
                        <i class="fa fa-save mr-2"></i> 保存修改
                    </button>
                </div>
            </form>
            <div id="password-message" class="mt-4 text-center text-red-500 hidden"></div>
        </div>
    </div>

    <!-- 主应用页面 -->
    <div id="app" class="hidden min-h-screen bg-gray-100">
        <!-- 顶部导航栏 -->
        <header class="bg-primary text-white shadow-md">
            <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-3 md:mb-0">
                    <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/3de15648cd4848b08d6bac7dacbc3fc3~tplv-a9rns2rl98-image.image?rcl=2025102409444359CDEB0476A3A6A2B278&amp;rk3s=8e244e95&amp;rrcfp=f06b921b&amp;x-expires=1763862346&amp;x-signature=ujvMtVBJ8yiImXi6jjesvNzQbKc%3D" alt="Logo" class="h-10 mr-3">
                    <h1 class="text-xl font-bold">实验室仪器管理系统</h1>
                </div>
                <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                    <div id="sync-info" class="flex items-center text-sm bg-white bg-opacity-20 px-3 py-1 rounded-md">
                        <span id="sync-status" class="mr-2 text-warning">同步中...</span>
                        <button id="sync-now-btn" class="bg-white bg-opacity-30 hover:bg-opacity-40 px-2 py-0.5 rounded text-xs flex items-center">
                            <i class="fa fa-refresh mr-1"></i> 同步
                        </button>
                    </div>
                    <div id="user-info" class="text-right">
                        <p class="text-sm">欢迎回来, <span id="current-username"></span></p>
                        <p class="text-xs opacity-75"><span id="current-role"></span></p>
                    </div>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm flex items-center">
                        <i class="fa fa-sign-out mr-1"></i> 退出
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <div class="container mx-auto px-4 py-6 flex flex-col md:flex-row">
            <!-- 左侧导航 -->
            <aside class="w-full md:w-64 bg-white rounded-lg shadow-md p-4 mb-6 md:mb-0 md:mr-6">
                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-md hover:bg-blue-50 hover:text-primary transition-all" data-target="dashboard">
                                <i class="fa fa-dashboard w-6"></i>
                                <span>仪器总览和维护</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-md hover:bg-blue-50 hover:text-primary transition-all" data-target="instruments">
                                <i class="fa fa-flask w-6"></i>
                                <span>仪器信息管理</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-md hover:bg-blue-50 hover:text-primary transition-all" data-target="meetings">
                                <i class="fa fa-comments w-6"></i>
                                <span>会议纪要管理</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-md hover:bg-blue-50 hover:text-primary transition-all" data-target="deviations">
                                <i class="fa fa-exclamation-triangle w-6"></i>
                                <span>偏离管理</span>
                            </a>
                        </li>
                        <li id="system-admin-nav" class="hidden">
                            <a href="#" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-md hover:bg-blue-50 hover:text-primary transition-all" data-target="system">
                                <i class="fa fa-cog w-6"></i>
                                <span>系统管理</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- 右侧内容 -->
            <main class="flex-1">
                <!-- 仪器总览和维护模块 -->
                <section id="dashboard-module" class="module-content">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">仪器总览和维护</h2>
                        
                        <!-- 统计卡片 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-blue-50 rounded-lg p-6 border-l-4 border-primary">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600 text-sm">总仪器数</p>
                                        <h3 class="text-3xl font-bold text-primary" id="total-instruments">0</h3>
                                    </div>
                                    <div class="bg-primary bg-opacity-10 p-3 rounded-full">
                                        <i class="fa fa-flask text-primary text-2xl"></i>
                                    </div>
                                </div>
                                <a href="#" class="text-sm text-primary mt-4 inline-block" id="view-all-instruments">查看所有仪器</a>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-6 border-l-4 border-warning">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600 text-sm">本月需维护仪器数</p>
                                        <h3 class="text-3xl font-bold text-warning" id="maintenance-this-month">0</h3>
                                    </div>
                                    <div class="bg-warning bg-opacity-10 p-3 rounded-full">
                                        <i class="fa fa-wrench text-warning text-2xl"></i>
                                    </div>
                                </div>
                                <a href="#" class="text-sm text-warning mt-4 inline-block" id="view-maintenance-instruments">查看需维护仪器</a>
                            </div>
                        </div>
                        
                        <!-- 筛选区域 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">筛选条件</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                                    <select id="filter-status" class="input-field w-full">
                                        <option value="">全部状态</option>
                                        <option value="normal">正常</option>
                                        <option value="maintenance">维修中</option>
                                        <option value="disabled">停用</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-room" class="block text-sm font-medium text-gray-700 mb-1">房间号</label>
                                    <input type="text" id="filter-room" class="input-field w-full" placeholder="输入房间号筛选">
                                </div>
                                <div>
                                    <label for="filter-maintenance" class="block text-sm font-medium text-gray-700 mb-1">维护时间</label>
                                    <select id="filter-maintenance" class="input-field w-full">
                                        <option value="">全部时间</option>
                                        <option value="this_month">本月</option>
                                        <option value="next_month">下月</option>
                                        <option value="overdue">已逾期</option>
                                        <option value="maintainable">可维护</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button id="clear-filters" class="text-sm text-gray-600 hover:text-primary mr-4">清除筛选</button>
                                <button id="apply-filters" class="btn-primary text-sm">应用筛选</button>
                            </div>
                        </div>
                        
                        <!-- 仪器维护看板 -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">仪器维护看板</h3>
                            <div id="instrument-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- 仪器卡片将通过JavaScript动态生成 -->
                            </div>
                            <div id="no-instruments-message" class="text-center py-8 text-gray-500 hidden">
                                <i class="fa fa-info-circle text-2xl mb-2"></i>
                                <p>没有符合条件的仪器</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 仪器信息管理模块 -->
                <section id="instruments-module" class="module-content hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800">仪器信息管理</h2>
                            <button id="add-instrument-btn" class="btn-primary flex items-center">
                                <i class="fa fa-plus mr-2"></i> 添加仪器
                            </button>
                        </div>
                        
                        <!-- 筛选区域 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="instrument-search" class="block text-sm font-medium text-gray-700 mb-1">搜索仪器</label>
                                    <div class="relative">
                                        <input type="text" id="instrument-search" class="input-field w-full" placeholder="输入仪器名称或编码">
                                    </div>
                                </div>
                                <div class="w-full md:w-auto">
                                    <label for="instrument-filter-status" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                                    <select id="instrument-filter-status" class="input-field w-full">
                                        <option value="">全部状态</option>
                                        <option value="normal">正常</option>
                                        <option value="maintenance">维修中</option>
                                        <option value="disabled">停用</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <label for="instrument-filter-maintenance" class="block text-sm font-medium text-gray-700 mb-1">维护时间</label>
                                    <select id="instrument-filter-maintenance" class="input-field w-full">
                                        <option value="">全部时间</option>
                                        <option value="this_month">本月</option>
                                        <option value="next_month">下月</option>
                                        <option value="overdue">已逾期</option>
                                        <option value="maintainable">可维护</option>
                                    </select>
                                </div>
                                <div class="w-full md:w-auto">
                                    <label for="instrument-filter-room" class="block text-sm font-medium text-gray-700 mb-1">房间号</label>
                                    <input type="text" id="instrument-filter-room" class="input-field w-full" placeholder="输入房间号筛选">
                                </div>
                                <div class="w-full md:w-auto flex items-end">
                                    <button id="clear-instrument-filters" class="text-sm text-gray-600 hover:text-primary mr-4">清除筛选</button>
                                    <button id="search-instruments" class="btn-primary text-sm">搜索</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 仪器列表 -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">仪器编码</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">仪器名称</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">房间号</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">下次维护时间</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="instrument-list" class="bg-white divide-y divide-gray-200">
                                    <!-- 仪器列表将通过JavaScript动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-instrument-list-message" class="text-center py-8 text-gray-500 hidden">
                            <i class="fa fa-info-circle text-2xl mb-2"></i>
                            <p>没有符合条件的仪器</p>
                        </div>
                        
                        <!-- 导入功能 -->
                        <div class="mt-6 flex justify-between items-center">
                            <div class="flex space-x-3">
                                <button id="import-instruments-btn" class="btn-secondary flex items-center">
                                    <i class="fa fa-upload mr-2"></i> 导入仪器信息
                                </button>
                                <button id="download-template-btn" class="btn-secondary flex items-center">
                                    <i class="fa fa-download mr-2"></i> 下载模板
                                </button>
                            </div>
                            <div class="text-sm text-gray-500">
                                显示 <span id="instrument-count">0</span> 条记录
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 会议纪要管理模块 -->
                <section id="meetings-module" class="module-content hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800">会议纪要管理</h2>
                            <button id="add-meeting-btn" class="btn-primary flex items-center">
                                <i class="fa fa-plus mr-2"></i> 添加会议纪要
                            </button>
                        </div>
                        
                        <!-- 搜索区域 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="meeting-search" class="block text-sm font-medium text-gray-700 mb-1">搜索纪要</label>
                                    <div class="relative">
                                        <input type="text" id="meeting-search" class="input-field w-full" placeholder="输入主题或内容关键词">
                                    </div>
                                </div>
                                <div class="w-full md:w-auto flex items-end">
                                    <button id="search-meetings" class="btn-primary text-sm">搜索</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 纪要列表 -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">会议纪要列表</h3>
                            <div id="meeting-list" class="space-y-4">
                                <!-- 会议纪要列表将通过JavaScript动态生成 -->
                            </div>
                            <div id="no-meetings-message" class="text-center py-8 text-gray-500 hidden">
                                <i class="fa fa-info-circle text-2xl mb-2"></i>
                                <p>没有符合条件的会议纪要</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 偏离管理模块 -->
                <section id="deviations-module" class="module-content hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800">偏离管理</h2>
                            <button id="add-deviation-btn" class="btn-primary flex items-center">
                                <i class="fa fa-plus mr-2"></i> 添加偏离管理
                            </button>
                        </div>
                        
                        <!-- 搜索区域 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <label for="deviation-search" class="block text-sm font-medium text-gray-700 mb-1">搜索记录</label>
                                    <div class="relative">
                                        <input type="text" id="deviation-search" class="input-field w-full" placeholder="输入主题或内容关键词">
                                    </div>
                                </div>
                                <div class="w-full md:w-auto flex items-end">
                                    <button id="search-deviations" class="btn-primary text-sm">搜索</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 偏离记录列表 -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">偏离记录列表</h3>
                            <div id="deviation-list" class="space-y-4">
                                <!-- 偏离记录列表将通过JavaScript动态生成 -->
                            </div>
                            <div id="no-deviations-message" class="text-center py-8 text-gray-500 hidden">
                                <i class="fa fa-info-circle text-2xl mb-2"></i>
                                <p>没有符合条件的偏离记录</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 系统管理模块 -->
                <section id="system-module" class="module-content hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-6">系统管理</h2>
                        
                        <!-- 导出功能区 -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">导出功能</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <h4 class="font-medium text-gray-800 mb-2">导出仪器信息</h4>
                                    <p class="text-sm text-gray-600 mb-4">导出所有仪器的详细信息，包括编码、名称、房间号、维护记录等</p>
                                    <button id="export-instruments" class="btn-secondary flex items-center">
                                        <i class="fa fa-download mr-2"></i> 导出仪器信息
                                    </button>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <h4 class="font-medium text-gray-800 mb-2">导出会议纪要</h4>
                                    <p class="text-sm text-gray-600 mb-4">导出所有会议纪要，包括主题、内容、创建时间等</p>
                                    <button id="export-meetings" class="btn-secondary flex items-center">
                                        <i class="fa fa-download mr-2"></i> 导出会议纪要
                                    </button>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <h4 class="font-medium text-gray-800 mb-2">导出偏离管理数据</h4>
                                    <p class="text-sm text-gray-600 mb-4">导出所有偏离记录，包括主题、内容、状态等</p>
                                    <button id="export-deviations" class="btn-secondary flex items-center">
                                        <i class="fa fa-download mr-2"></i> 导出偏离记录
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 账号管理区 -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-700">账号管理</h3>
                                <button id="add-user-btn" class="btn-primary flex items-center">
                                    <i class="fa fa-plus mr-2"></i> 添加账号
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后登录</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-list" class="bg-white divide-y divide-gray-200">
                                        <!-- 用户列表将通过JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 审计系统区 -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">审计系统</h3>
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <div class="flex flex-wrap gap-4">
                                    <div class="flex-1 min-w-[200px]">
                                        <label for="audit-search" class="block text-sm font-medium text-gray-700 mb-1">搜索日志</label>
                                        <div class="relative">
                                            <input type="text" id="audit-search" class="input-field w-full pl-10" placeholder="输入关键词搜索日志">
                                            <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                                        </div>
                                    </div>
                                    <div class="w-full md:w-auto flex items-end">
                                        <button id="search-audit" class="btn-primary text-sm">搜索</button>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4 h-[400px] overflow-y-auto">
                                <div id="audit-logs" class="space-y-2">
                                    <!-- 审计日志将通过JavaScript动态生成 -->
                                </div>
                                <div id="no-audit-message" class="text-center py-8 text-gray-500 hidden">
                                    <i class="fa fa-info-circle text-2xl mb-2"></i>
                                    <p>没有符合条件的审计日志</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- 仪器详情弹窗 -->
    <div id="instrument-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">仪器详情</h2>
                <button id="close-instrument-detail" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="instrument-detail-content">
                <!-- 仪器详情将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 添加仪器编辑弹窗 -->
    <div id="instrument-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800" id="instrument-edit-title">添加仪器</h2>
                <button id="close-instrument-edit" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="instrument-form" class="space-y-6">
                <input type="hidden" id="instrument-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-instrument-code" class="block text-sm font-medium text-gray-700 mb-1">仪器编码 <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-instrument-code" name="code" class="input-field w-full" placeholder="请输入仪器编码" required="">
                    </div>
                    <div>
                        <label for="edit-instrument-name" class="block text-sm font-medium text-gray-700 mb-1">仪器名称 <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-instrument-name" name="name" class="input-field w-full" placeholder="请输入仪器名称" required="">
                    </div>
                    <div>
                        <label for="edit-instrument-room" class="block text-sm font-medium text-gray-700 mb-1">房间号 <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-instrument-room" name="roomNumber" class="input-field w-full" placeholder="请输入房间号" required="">
                    </div>
                    <div>
                        <label for="edit-instrument-status" class="block text-sm font-medium text-gray-700 mb-1">状态 <span class="text-red-500">*</span></label>
                        <select id="edit-instrument-status" name="status" class="input-field w-full" required="">
                            <option value="normal">正常</option>
                            <option value="maintenance">维修中</option>
                            <option value="disabled">停用</option>
                        </select>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">维护记录</h3>
                    <div id="maintenance-records" class="space-y-4">
                        <div class="maintenance-record bg-gray-50 p-4 rounded-md">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">维护类型</label>
                                    <input type="text" class="maintenance-type input-field w-full" placeholder="请输入维护类型">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">维护内容</label>
                                    <input type="text" class="maintenance-content input-field w-full" placeholder="请输入维护内容">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">维护周期 (天)</label>
                                    <input type="number" class="maintenance-cycle input-field w-full" placeholder="请输入维护周期">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">下次维护时间</label>
                                    <input type="date" class="maintenance-next input-field w-full">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="button" id="add-maintenance-record" class="btn-secondary flex items-center text-sm">
                            <i class="fa fa-plus mr-1"></i> 添加维护记录
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-instrument-edit" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 账号管理弹窗 -->
    <div id="user-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800" id="user-modal-title">添加账号</h2>
                <button id="close-user-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="user-form" class="space-y-6">
                <input type="hidden" id="user-id">
                <div>
                    <label for="edit-username" class="block text-sm font-medium text-gray-700 mb-1">用户名 <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-username" name="username" class="input-field w-full" placeholder="请输入用户名" required="">
                </div>
                <div id="password-field-container">
                    <label for="edit-password" class="block text-sm font-medium text-gray-700 mb-1">密码 <span class="text-red-500">*</span></label>
                    <input type="password" id="edit-password" name="password" class="input-field w-full" placeholder="请输入密码" required="">
                </div>
                <div>
                    <label for="edit-role" class="block text-sm font-medium text-gray-700 mb-1">角色 <span class="text-red-500">*</span></label>
                    <select id="edit-role" name="role" class="input-field w-full" required="">
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-user-edit" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 确认删除弹窗 -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                    <i class="fa fa-exclamation-triangle text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">确认</h2>
                <p class="text-gray-600 mt-2" id="delete-confirmation-message">您确定要删除这条记录吗？此操作不可撤销。</p>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                <button id="confirm-delete" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">确认</button>
            </div>
        </div>
    </div>
    
    <!-- 添加会议纪要弹窗 -->
    <div id="add-meeting-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">添加会议纪要</h2>
                <button id="close-add-meeting" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 富文本编辑器 -->
            <div class="mb-6">
                <div class="mb-4">
                    <input type="text" id="meeting-title" class="input-field w-full" placeholder="请输入会议主题">
                </div>
                <div class="border border-gray-300 rounded-md overflow-hidden">
                    <div class="bg-gray-50 border-b border-gray-300 p-2 flex flex-wrap gap-2">
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="bold">
                            <i class="fa fa-bold"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="italic">
                            <i class="fa fa-italic"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="underline">
                            <i class="fa fa-underline"></i>
                        </button>
                        <span class="border-r border-gray-300 h-6 mx-1"></span>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="insertUnorderedList">
                            <i class="fa fa-list-ul"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="insertOrderedList">
                            <i class="fa fa-list-ol"></i>
                        </button>
                        <span class="border-r border-gray-300 h-6 mx-1"></span>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="justifyLeft">
                            <i class="fa fa-align-left"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="justifyCenter">
                            <i class="fa fa-align-center"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="justifyRight">
                            <i class="fa fa-align-right"></i>
                        </button>
                    </div>
                    <div id="meeting-content" class="p-4 min-h-[200px] focus:outline-none" contenteditable="true"></div>
                </div>
                <div class="flex justify-between mt-4">
                    <div id="save-status" class="text-sm text-gray-500">自动保存中...</div>
                    <button id="save-meeting" class="btn-primary flex items-center">
                        <i class="fa fa-save mr-2"></i> 保存纪要
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加偏离管理弹窗 -->
    <!-- 自定义弹窗 -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden" style="transition: opacity 0.3s ease;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md" style="transform: translateY(-20px); transition: transform 0.3s ease;">
            <div class="p-6">
                <div id="modal-title" class="text-xl font-semibold text-gray-900 mb-4"></div>
                <div id="modal-message" class="text-gray-700 mb-6"></div>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100">取消</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 审计日志详情弹窗 -->
    <div id="audit-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden" style="transition: opacity 0.3s ease;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[80vh] overflow-hidden flex flex-col" style="transform: translateY(-20px); transition: transform 0.3s ease;">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-900" id="audit-details-title">操作详情</h3>
                    <button id="close-audit-details" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="mb-4">
                    <div class="text-sm text-gray-500 mb-1">操作时间</div>
                    <div class="font-medium" id="audit-details-timestamp"></div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-gray-500 mb-1">操作用户</div>
                    <div class="font-medium" id="audit-details-user"></div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-gray-500 mb-1">操作类型</div>
                    <div class="font-medium" id="audit-details-action"></div>
                </div>
                <div class="mb-4">
                    <div class="text-sm text-gray-500 mb-1">操作详情</div>
                    <div class="font-medium" id="audit-details-details"></div>
                </div>
                <div id="audit-details-snapshot-container" class="mt-6 border-t border-gray-200 pt-6 hidden">
                    <div class="text-sm text-gray-500 mb-2">数据快照</div>
                    <div class="bg-gray-50 p-4 rounded-md overflow-x-auto">
                        <pre id="audit-details-snapshot" class="text-xs text-gray-700 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button id="audit-details-close" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100">关闭</button>
            </div>
        </div>
    </div>
    
    <style>
        #custom-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #custom-modal:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }
        
        #custom-modal:not(.hidden) .bg-white {
            transform: translateY(0);
        }
    </style>

    <div id="add-deviation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">添加偏离管理</h2>
                <button id="close-add-deviation" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 富文本编辑器 -->
            <div class="mb-6">
                <div class="mb-4">
                    <input type="text" id="deviation-title" class="input-field w-full" placeholder="请输入偏离主题">
                </div>
                <div class="border border-gray-300 rounded-md overflow-hidden">
                    <div class="bg-gray-50 border-b border-gray-300 p-2 flex flex-wrap gap-2">
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="bold">
                            <i class="fa fa-bold"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="italic">
                            <i class="fa fa-italic"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="underline">
                            <i class="fa fa-underline"></i>
                        </button>
                        <span class="border-r border-gray-300 h-6 mx-1"></span>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="insertUnorderedList">
                            <i class="fa fa-list-ul"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="insertOrderedList">
                            <i class="fa fa-list-ol"></i>
                        </button>
                        <span class="border-r border-gray-300 h-6 mx-1"></span>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="justifyLeft">
                            <i class="fa fa-align-left"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="justifyCenter">
                            <i class="fa fa-align-center"></i>
                        </button>
                        <button class="editor-btn p-1 hover:bg-gray-200 rounded" data-command="justifyRight">
                            <i class="fa fa-align-right"></i>
                        </button>
                    </div>
                    <div id="deviation-content" class="p-4 min-h-[200px] focus:outline-none" contenteditable="true"></div>
                </div>
                <div class="flex flex-wrap justify-between items-center mt-4 gap-4">
                    <div id="deviation-save-status" class="text-sm text-gray-500">自动保存中...</div>
                    <div class="flex items-center">
                        <select id="deviation-status" class="input-field mr-4">
                            <option value="pending">待处理</option>
                            <option value="resolved">已解决</option>
                        </select>
                        <button id="save-deviation" class="btn-primary flex items-center">
                            <i class="fa fa-save mr-2"></i> 保存偏离
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入仪器信息弹窗 -->
    <div id="import-instruments-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">导入仪器信息</h2>
                <button id="close-import-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-6">
                <p class="text-gray-600 mb-4">请选择CSV格式的仪器信息文件进行导入。</p>
                <div class="border-2 border-dashed border-gray-300 rounded-md p-6 text-center">
                    <i class="fa fa-cloud-upload text-gray-400 text-3xl mb-2"></i>
                    <p class="text-gray-500 mb-2">拖放文件到此处或</p>
                    <label class="btn-secondary cursor-pointer">
                        <span>选择文件</span>
                        <input type="file" id="import-file" accept=".csv" class="hidden">
                    </label>
                </div>
                <div id="import-file-name" class="mt-4 text-sm text-gray-600 hidden"></div>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-import" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                <button id="confirm-import" class="btn-primary">导入</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 全局变量
        let currentUser = null;
        let currentModule = 'dashboard';
        let instrumentsData = { instruments: [] };
        let meetingData = { meetings: [] };
        let deviationData = { deviations: [] };
        let userData = { users: [] };
        let auditData = { logs: [] };
        let currentInstrumentId = null;
        let currentMeetingId = null;
        let currentDeviationId = null;
        let currentUserId = null;
        let deleteCallback = null;
        let autoSaveInterval = null;
        let idleTimeout = null;

        // 初始化函数
        function init() {
            // 初始化数据
            initializeData();
            
            // 绑定事件
            bindEvents();
            
            // 检查登录状态
            checkLoginStatus();
            
            // 初始化完成后，如果有同步函数，触发首次同步
            if (window.syncData) {
                setTimeout(() => {
                    // 触发同步事件
                    const event = new CustomEvent('lc:requestSync');
                    document.dispatchEvent(event);
                }, 2000);
            }
            
            // 初始化数据同步状态显示
            updateSyncStatusDisplay();
        }

        // 初始化数据
        function initializeData() {
            // 检查本地存储中是否有数据
            if (!localStorage.getItem('instrumentData')) {
                // 初始化示例仪器数据
                instrumentsData = {
                    instruments: [
                        {
                            id: 'INS001',
                            code: 'INS001',
                            name: '电子天平',
                            roomNumber: 'R101',
                            status: 'normal',
                            maintenanceRecords: [
                                {
                                    type: '校准',
                                    content: '校准天平精度',
                                    cycle: 30,
                                    lastMaintenance: '2023-06-15',
                                    nextMaintenance: getNextMonthDate(),
                                    completedBy: 'admin',
                                    completedAt: '2023-06-15T14:30:00'
                                }
                            ],
                            createdAt: '2023-01-10T09:00:00',
                            updatedAt: '2023-06-15T14:30:00'
                        },
                        {
                            id: 'INS002',
                            code: 'INS002',
                            name: 'pH计',
                            roomNumber: 'R102',
                            status: 'maintenance',
                            maintenanceRecords: [
                                {
                                    type: '校准',
                                    content: '校准pH电极',
                                    cycle: 60,
                                    lastMaintenance: '2023-05-20',
                                    nextMaintenance: getNextWeekDate(),
                                    completedBy: 'user1',
                                    completedAt: '2023-05-20T10:15:00'
                                }
                            ],
                            createdAt: '2023-02-15T11:30:00',
                            updatedAt: '2023-05-20T10:15:00'
                        },
                        {
                            id: 'INS003',
                            code: 'INS003',
                            name: '高效液相色谱仪',
                            roomNumber: 'R201',
                            status: 'normal',
                            maintenanceRecords: [
                                {
                                    type: '维护',
                                    content: '更换色谱柱',
                                    cycle: 90,
                                    lastMaintenance: '2023-04-10',
                                    nextMaintenance: getNextThreeMonthDate(),
                                    completedBy: 'admin',
                                    completedAt: '2023-04-10T09:45:00'
                                },
                                {
                                    type: '校准',
                                    content: '校准检测器',
                                    cycle: 180,
                                    lastMaintenance: '2023-01-15',
                                    nextMaintenance: getNextSixMonthDate(),
                                    completedBy: 'admin',
                                    completedAt: '2023-01-15T11:20:00'
                                }
                            ],
                            createdAt: '2022-11-05T14:20:00',
                            updatedAt: '2023-04-10T09:45:00'
                        },
                        {
                            id: 'INS004',
                            code: 'INS004',
                            name: '紫外分光光度计',
                            roomNumber: 'R103',
                            status: 'disabled',
                            maintenanceRecords: [
                                {
                                    type: '维修',
                                    content: '更换光源',
                                    cycle: 365,
                                    lastMaintenance: '2023-03-25',
                                    nextMaintenance: '2024-03-25',
                                    completedBy: 'user2',
                                    completedAt: '2023-03-25T16:10:00'
                                }
                            ],
                            createdAt: '2022-12-18T10:00:00',
                            updatedAt: '2023-03-25T16:10:00'
                        },
                        {
                            id: 'INS005',
                            code: 'INS005',
                            name: '离心机',
                            roomNumber: 'R202',
                            status: 'normal',
                            maintenanceRecords: [
                                {
                                    type: '维护',
                                    content: '清洁转子',
                                    cycle: 45,
                                    lastMaintenance: '2023-07-01',
                                    nextMaintenance: getNextMonthDate(45),
                                    completedBy: 'user1',
                                    completedAt: '2023-07-01T13:25:00'
                                }
                            ],
                            createdAt: '2023-03-12T09:30:00',
                            updatedAt: '2023-07-01T13:25:00'
                        }
                    ]
                };
                saveData('instrumentData', instrumentsData);
            } else {
                instrumentsData = getData('instrumentData');
            }

            if (!localStorage.getItem('meetingData')) {
                // 初始化示例会议数据
                meetingData = {
                    meetings: [
                        {
                            id: 'MEET001',
                            title: '月度仪器维护会议',
                            content: '<p>讨论了本月仪器维护计划和问题。</p><ul><li>电子天平需要重新校准</li><li>pH计出现不稳定现象</li><li>高效液相色谱仪运行正常</li></ul>',
                            createdBy: 'admin',
                            createdAt: '2023-07-10T15:00:00',
                            updatedAt: '2023-07-10T16:30:00'
                        },
                        {
                            id: 'MEET002',
                            title: '新仪器操作培训',
                            content: '<p>对新购入的紫外分光光度计进行操作培训。</p><p>培训内容包括：</p><ol><li>仪器基本原理</li><li>操作步骤</li><li>日常维护</li><li>常见问题处理</li></ol>',
                            createdBy: 'user1',
                            createdAt: '2023-06-25T10:00:00',
                            updatedAt: '2023-06-25T11:45:00'
                        }
                    ]
                };
                saveData('meetingData', meetingData);
            } else {
                meetingData = getData('meetingData');
            }

            if (!localStorage.getItem('deviationData')) {
                // 初始化示例偏离数据
                deviationData = {
                    deviations: [
                        {
                            id: 'DEV001',
                            title: '天平精度偏离',
                            content: '<p>电子天平精度超出允许范围，需要重新校准。</p><p>可能原因：</p><ul><li>长时间未校准</li><li>环境温度变化较大</li><li>可能受到震动影响</li></ul>',
                            createdBy: 'user1',
                            createdAt: '2023-07-15T10:15:00',
                            updatedAt: '2023-07-15T11:00:00',
                            status: 'resolved'
                        },
                        {
                            id: 'DEV002',
                            title: 'pH计响应缓慢',
                            content: '<p>pH计响应速度明显变慢，影响测量效率。</p><p>建议：</p><ol><li>检查电极是否需要更换</li><li>清洁电极表面</li><li>重新校准仪器</li></ol>',
                            createdBy: 'user2',
                            createdAt: '2023-07-18T09:30:00',
                            updatedAt: '2023-07-18T09:30:00',
                            status: 'pending'
                        }
                    ]
                };
                saveData('deviationData', deviationData);
            } else {
                deviationData = getData('deviationData');
            }

            if (!localStorage.getItem('userData')) {
                // 初始化用户数据
                userData = {
                    users: [
                        {
                            id: 'admin',
                            username: 'admin',
                            password: 'admin123',
                            role: 'admin',
                            lastLogin: null,
                            isActive: true
                        },
                        {
                            id: 'user1',
                            username: 'user1',
                            password: 'user123',
                            role: 'user',
                            lastLogin: null,
                            isActive: true
                        },
                        {
                            id: 'user2',
                            username: 'user2',
                            password: 'user123',
                            role: 'user',
                            lastLogin: null,
                            isActive: true
                        }
                    ]
                };
                saveData('userData', userData);
            } else {
                userData = getData('userData');
            }

            if (!localStorage.getItem('auditData')) {
                // 初始化审计日志数据
                auditData = {
                    logs: [
                        {
                            id: 'LOG001',
                            user: 'admin',
                            action: 'system_start',
                            details: '系统初始化',
                            timestamp: new Date().toISOString()
                        }
                    ]
                };
                saveData('auditData', auditData);
            } else {
                auditData = getData('auditData');
            }
        }

        // 绑定事件
        function bindEvents() {
            // 登录表单提交
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            
            // 绑定同步按钮事件
            document.getElementById('sync-now-btn').addEventListener('click', function() {
                if (window.syncData) {
                    // 更新同步状态显示
                    document.getElementById('sync-status').textContent = '同步中...';
                    document.getElementById('sync-status').classList.remove('text-green-500', 'text-red-500');
                    document.getElementById('sync-status').classList.add('text-warning');
                    
                    // 显示加载动画
                    this.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 同步中...';
                    this.disabled = true;
                    
                    // 执行同步
                    syncData().then(success => {
                        if (success) {
                            // 同步成功
                            document.getElementById('sync-status').textContent = '已同步';
                            document.getElementById('sync-status').classList.remove('text-warning', 'text-red-500');
                            document.getElementById('sync-status').classList.add('text-green-500');
                        } else {
                            // 同步失败
                            document.getElementById('sync-status').textContent = '同步失败';
                            document.getElementById('sync-status').classList.remove('text-warning', 'text-green-500');
                            document.getElementById('sync-status').classList.add('text-red-500');
                        }
                    }).catch(error => {
                        console.error('同步失败:', error);
                        document.getElementById('sync-status').textContent = '同步失败';
                        document.getElementById('sync-status').classList.remove('text-warning', 'text-green-500');
                        document.getElementById('sync-status').classList.add('text-red-500');
                    }).finally(() => {
                        // 恢复按钮状态
                        this.innerHTML = '<i class="fa fa-refresh mr-1"></i> 同步';
                        this.disabled = false;
                    });
                }
            });

            // 忘记密码链接
            document.getElementById('forgot-password').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('change-password-modal').classList.remove('hidden');
            });

            // 关闭修改密码弹窗
            document.getElementById('close-password-modal').addEventListener('click', function() {
                document.getElementById('change-password-modal').classList.add('hidden');
                document.getElementById('password-message').classList.add('hidden');
            });

            // 修改密码表单提交
            document.getElementById('change-password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                changePassword();
            });

            // 退出登录
            document.getElementById('logout-btn').addEventListener('click', logout);

            // 导航链接点击
            document.querySelectorAll('.nav-link').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    switchModule(target);
                });
            });

            // 应用筛选按钮
            document.getElementById('apply-filters').addEventListener('click', function() {
                renderInstrumentCards();
            });

            // 清除筛选按钮
            document.getElementById('clear-filters').addEventListener('click', function() {
                document.getElementById('filter-status').value = '';
                document.getElementById('filter-room').value = '';
                document.getElementById('filter-maintenance').value = '';
                renderInstrumentCards();
            });

            // 查看所有仪器链接
            document.getElementById('view-all-instruments').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('filter-status').value = '';
                document.getElementById('filter-room').value = '';
                document.getElementById('filter-maintenance').value = '';
                renderInstrumentCards();
            });

            // 查看需维护仪器链接
            document.getElementById('view-maintenance-instruments').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('filter-maintenance').value = 'this_month';
                renderInstrumentCards();
            });

            // 关闭仪器详情弹窗
            document.getElementById('close-instrument-detail').addEventListener('click', function() {
                document.getElementById('instrument-detail-modal').classList.add('hidden');
            });

            // 添加仪器按钮
            document.getElementById('add-instrument-btn').addEventListener('click', function() {
                openAddInstrumentModal();
            });

            // 关闭仪器编辑弹窗
            document.getElementById('close-instrument-edit').addEventListener('click', function() {
                document.getElementById('instrument-edit-modal').classList.add('hidden');
            });

            // 取消仪器编辑
            document.getElementById('cancel-instrument-edit').addEventListener('click', function() {
                document.getElementById('instrument-edit-modal').classList.add('hidden');
            });

            // 仪器表单提交
            document.getElementById('instrument-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInstrument();
            });

            // 添加维护记录
            document.getElementById('add-maintenance-record').addEventListener('click', function() {
                addMaintenanceRecord();
            });

            // 搜索仪器
            document.getElementById('search-instruments').addEventListener('click', function() {
                renderInstrumentList();
            });

            // 清除仪器筛选
            document.getElementById('clear-instrument-filters').addEventListener('click', function() {
                document.getElementById('instrument-search').value = '';
                document.getElementById('instrument-filter-status').value = '';
                document.getElementById('instrument-filter-room').value = '';
                document.getElementById('instrument-filter-maintenance').value = '';
                renderInstrumentList();
            });

            // 导入仪器信息按钮
            document.getElementById('import-instruments-btn').addEventListener('click', function() {
                document.getElementById('import-instruments-modal').classList.remove('hidden');
            });
            
            // 下载仪器模板按钮
            document.getElementById('download-template-btn').addEventListener('click', function() {
                downloadInstrumentTemplate();
            });

            // 关闭导入仪器弹窗
            document.getElementById('close-import-modal').addEventListener('click', function() {
                document.getElementById('import-instruments-modal').classList.add('hidden');
            });

            // 取消导入
            document.getElementById('cancel-import').addEventListener('click', function() {
                document.getElementById('import-instruments-modal').classList.add('hidden');
            });

            // 选择导入文件
            document.getElementById('import-file').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const fileName = e.target.files[0].name;
                    document.getElementById('import-file-name').textContent = `已选择: ${fileName}`;
                    document.getElementById('import-file-name').classList.remove('hidden');
                }
            });

            // 确认导入
            document.getElementById('confirm-import').addEventListener('click', function() {
                const fileInput = document.getElementById('import-file');
                if (fileInput.files.length > 0) {
                    importInstruments(fileInput.files[0]);
                } else {
                    alert('请选择要导入的文件');
                }
            });

            // 富文本编辑器按钮
            document.querySelectorAll('.editor-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    document.execCommand(command, false, null);
                });
            });

            // 保存会议纪要
            document.getElementById('save-meeting').addEventListener('click', saveMeeting);

            // 搜索会议纪要
            document.getElementById('search-meetings').addEventListener('click', function() {
                renderMeetingList();
            });

            // 保存偏离记录
            document.getElementById('save-deviation').addEventListener('click', saveDeviation);

            // 搜索偏离记录
            document.getElementById('search-deviations').addEventListener('click', function() {
                renderDeviationList();
            });

            // 添加用户按钮
            document.getElementById('add-user-btn').addEventListener('click', function() {
                openAddUserModal();
            });

            // 关闭用户管理弹窗
            document.getElementById('close-user-modal').addEventListener('click', function() {
                document.getElementById('user-management-modal').classList.add('hidden');
            });

            // 取消用户编辑
            document.getElementById('cancel-user-edit').addEventListener('click', function() {
                document.getElementById('user-management-modal').classList.add('hidden');
            });

            // 用户表单提交
            document.getElementById('user-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });

            // 搜索审计日志
            document.getElementById('search-audit').addEventListener('click', function() {
                renderAuditLogs();
            });

            // 导出仪器信息
            document.getElementById('export-instruments').addEventListener('click', exportInstruments);

            // 导出会议纪要
            document.getElementById('export-meetings').addEventListener('click', exportMeetings);

            // 导出偏离记录
            document.getElementById('export-deviations').addEventListener('click', exportDeviations);

            // 关闭确认删除弹窗
            document.getElementById('cancel-delete').addEventListener('click', function() {
                document.getElementById('confirm-delete-modal').classList.add('hidden');
            });

            // 确认删除
            document.getElementById('confirm-delete').addEventListener('click', function() {
                if (deleteCallback) {
                    deleteCallback();
                    document.getElementById('confirm-delete-modal').classList.add('hidden');
                }
            });

            // 监听用户活动，重置闲置计时器
            document.addEventListener('mousemove', resetIdleTimer);
            document.addEventListener('keypress', resetIdleTimer);
            document.addEventListener('click', resetIdleTimer);
        }

        // 检查登录状态
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            } else {
                showLoginPage();
            }
        }

        // 显示登录页面
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        // 显示应用
        function showApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // 设置应用已初始化标记
            window.appInitialized = true;
            
            // 更新用户信息
            document.getElementById('current-username').textContent = currentUser.username;
            document.getElementById('current-role').textContent = currentUser.role === 'admin' ? '管理员' : '普通用户';
            
            // 控制系统管理菜单显示
            if (currentUser.role === 'admin') {
                document.getElementById('system-admin-nav').classList.remove('hidden');
            } else {
                document.getElementById('system-admin-nav').classList.add('hidden');
            }
            
            // 切换到默认模块
            switchModule('dashboard');
            
            // 启动闲置计时器
            startIdleTimer();
            
            // 添加登录审计日志
            addAuditLog(currentUser.username, 'login', '用户登录系统');
        }

        // 登录
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            // 查找用户
            const user = userData.users.find(u => u.username === username && u.password === password && u.isActive);
            
            if (user) {
                // 更新最后登录时间
                user.lastLogin = new Date().toISOString();
                saveData('userData', userData);
                
                // 保存当前用户
                currentUser = {
                    id: user.id,
                    username: user.username,
                    role: user.role
                };
                
                if (rememberMe) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                } else {
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                // 显示应用
                showApp();
                
                // 重置表单
                document.getElementById('login-form').reset();
                document.getElementById('login-message').classList.add('hidden');
            } else {
                // 显示错误消息
                document.getElementById('login-message').textContent = '用户名或密码错误';
                document.getElementById('login-message').classList.remove('hidden');
            }
        }

        // 退出登录
        function logout() {
            // 清除当前用户
            currentUser = null;
            localStorage.removeItem('currentUser');
            sessionStorage.removeItem('currentUser');
            
            // 停止自动保存和闲置计时器
            stopAutoSave();
            stopIdleTimer();
            
            // 添加退出审计日志
            addAuditLog(currentUser ? currentUser.username : 'unknown', 'logout', '用户退出系统');
            
            // 显示登录页面
            showLoginPage();
        }

        // 修改密码
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // 验证新密码是否一致
            if (newPassword !== confirmPassword) {
                document.getElementById('password-message').textContent = '两次输入的新密码不一致';
                document.getElementById('password-message').classList.remove('hidden');
                return;
            }
            
            // 查找用户
            const user = userData.users.find(u => u.username === document.getElementById('username').value && u.password === currentPassword);
            
            if (user) {
                // 更新密码
                user.password = newPassword;
                saveData('userData', userData);
                
                // 显示成功消息
                document.getElementById('password-message').textContent = '密码修改成功';
                document.getElementById('password-message').classList.remove('hidden');
                document.getElementById('password-message').classList.remove('text-red-500');
                document.getElementById('password-message').classList.add('text-green-500');
                
                // 重置表单
                setTimeout(function() {
                    document.getElementById('change-password-form').reset();
                    document.getElementById('change-password-modal').classList.add('hidden');
                    document.getElementById('password-message').classList.add('hidden');
                    document.getElementById('password-message').classList.remove('text-green-500');
                    document.getElementById('password-message').classList.add('text-red-500');
                }, 1500);
                
                // 添加审计日志
                addAuditLog(user.username, 'change_password', '用户修改密码');
            } else {
                // 显示错误消息
                document.getElementById('password-message').textContent = '当前密码错误';
                document.getElementById('password-message').classList.remove('hidden');
            }
        }

        // 切换模块
        function switchModule(moduleName) {
            // 更新当前模块
            currentModule = moduleName;
            
            // 更新导航链接样式
            document.querySelectorAll('.nav-link').forEach(function(link) {
                if (link.getAttribute('data-target') === moduleName) {
                    link.classList.add('bg-blue-50', 'text-primary');
                    link.classList.remove('text-gray-700');
                } else {
                    link.classList.remove('bg-blue-50', 'text-primary');
                    link.classList.add('text-gray-700');
                }
            });
            
            // 隐藏所有模块内容
            document.querySelectorAll('.module-content').forEach(function(content) {
                content.classList.add('hidden');
            });
            
            // 显示选中的模块内容
            document.getElementById(`${moduleName}-module`).classList.remove('hidden');
            
            // 根据模块执行相应的初始化函数
            switch (moduleName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'instruments':
                    renderInstrumentList();
                    break;
                case 'meetings':
                    renderMeetingList();
                    startAutoSave('meeting');
                    break;
                case 'deviations':
                    renderDeviationList();
                    startAutoSave('deviation');
                    break;
                case 'system':
                    renderUserList();
                    renderAuditLogs();
                    break;
            }
        }

        // 渲染仪表盘
        function renderDashboard() {
            // 更新统计数据
            updateStatistics();
            
            // 渲染仪器卡片
            renderInstrumentCards();
        }

        // 更新统计数据
        function updateStatistics() {
            // 总仪器数
            const totalInstruments = instrumentsData.instruments.length;
            document.getElementById('total-instruments').textContent = totalInstruments;
            
            // 本月需维护仪器数
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            let maintenanceThisMonth = 0;
            
            instrumentsData.instruments.forEach(function(instrument) {
                instrument.maintenanceRecords.forEach(function(record) {
                    const nextMaintenanceDate = new Date(record.nextMaintenance);
                    if (nextMaintenanceDate.getMonth() === currentMonth && nextMaintenanceDate.getFullYear() === currentYear) {
                        maintenanceThisMonth++;
                    }
                });
            });
            
            document.getElementById('maintenance-this-month').textContent = maintenanceThisMonth;
        }

        // 渲染仪器卡片
        function renderInstrumentCards() {
            const statusFilter = document.getElementById('filter-status').value;
            const roomFilter = document.getElementById('filter-room').value;
            const maintenanceFilter = document.getElementById('filter-maintenance').value;
            
            // 筛选仪器
            let filteredInstruments = instrumentsData.instruments;
            
            if (statusFilter) {
                filteredInstruments = filteredInstruments.filter(instrument => instrument.status === statusFilter);
            }
            
            if (roomFilter) {
                filteredInstruments = filteredInstruments.filter(instrument => instrument.roomNumber.toLowerCase().includes(roomFilter.toLowerCase()));
            }
            
            if (maintenanceFilter) {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const nextMonth = (currentMonth + 1) % 12;
                const nextMonthYear = nextMonth === 0 ? currentYear + 1 : currentYear;
                
                filteredInstruments = filteredInstruments.filter(instrument => {
                    let match = false;
                    
                    instrument.maintenanceRecords.forEach(function(record) {
                        const nextMaintenanceDate = new Date(record.nextMaintenance);
                        
                        switch (maintenanceFilter) {
                            case 'this_month':
                                if (nextMaintenanceDate.getMonth() === currentMonth && nextMaintenanceDate.getFullYear() === currentYear) {
                                    match = true;
                                }
                                break;
                            case 'next_month':
                                if (nextMaintenanceDate.getMonth() === nextMonth && nextMaintenanceDate.getFullYear() === nextMonthYear) {
                                    match = true;
                                }
                                break;
                            case 'overdue':
                                if (nextMaintenanceDate < today) {
                                    match = true;
                                }
                                break;
                            case 'maintainable':
                                // 可维护：下次维护日期前20天内
                                const twentyDaysLater = new Date();
                                twentyDaysLater.setDate(today.getDate() + 20);
                                if (nextMaintenanceDate >= today && nextMaintenanceDate <= twentyDaysLater) {
                                    match = true;
                                }
                                break;
                        }
                    });
                    
                    return match;
                });
            }
            
            if (maintenanceFilter) {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const nextMonth = (currentMonth + 1) % 12;
                const nextMonthYear = nextMonth === 0 ? currentYear + 1 : currentYear;
                
                filteredInstruments = filteredInstruments.filter(instrument => {
                    let match = false;
                    
                    instrument.maintenanceRecords.forEach(function(record) {
                        const nextMaintenanceDate = new Date(record.nextMaintenance);
                        
                        switch (maintenanceFilter) {
                            case 'this_month':
                                if (nextMaintenanceDate.getMonth() === currentMonth && nextMaintenanceDate.getFullYear() === currentYear) {
                                    match = true;
                                }
                                break;
                            case 'next_month':
                                if (nextMaintenanceDate.getMonth() === nextMonth && nextMaintenanceDate.getFullYear() === nextMonthYear) {
                                    match = true;
                                }
                                break;
                            case 'overdue':
                                if (nextMaintenanceDate < today) {
                                    match = true;
                                }
                                break;
                            case 'maintainable':
                                // 可维护：下次维护日期前20天内
                                const twentyDaysLater = new Date();
                                twentyDaysLater.setDate(today.getDate() + 20);
                                if (nextMaintenanceDate >= today && nextMaintenanceDate <= twentyDaysLater) {
                                    match = true;
                                }
                                break;
                        }
                    });
                    
                    return match;
                });
            }
            
            // 渲染卡片
            const instrumentCardsContainer = document.getElementById('instrument-cards');
            instrumentCardsContainer.innerHTML = '';
            
            if (filteredInstruments.length === 0) {
                document.getElementById('no-instruments-message').classList.remove('hidden');
                return;
            }
            
            document.getElementById('no-instruments-message').classList.add('hidden');
            
            filteredInstruments.forEach(function(instrument) {
                // 获取最近的维护记录
                let nextMaintenanceDate = null;
                let maintenanceType = '';
                
                if (instrument.maintenanceRecords.length > 0) {
                    // 按下次维护时间排序
                    const sortedRecords = [...instrument.maintenanceRecords].sort((a, b) => {
                        return new Date(a.nextMaintenance) - new Date(b.nextMaintenance);
                    });
                    
                    const nearestRecord = sortedRecords[0];
                    nextMaintenanceDate = new Date(nearestRecord.nextMaintenance);
                    maintenanceType = nearestRecord.type;
                }
                
                // 计算距离下次维护的天数
                let daysUntilMaintenance = null;
                if (nextMaintenanceDate) {
                    const today = new Date();
                    const diffTime = nextMaintenanceDate - today;
                    daysUntilMaintenance = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                
                // 确定状态标签样式
                let statusClass = '';
                let statusText = '';
                
                switch (instrument.status) {
                    case 'normal':
                        statusClass = 'status-normal';
                        statusText = '正常';
                        break;
                    case 'maintenance':
                        statusClass = 'status-maintenance';
                        statusText = '维修中';
                        break;
                    case 'disabled':
                        statusClass = 'status-disabled';
                        statusText = '停用';
                        break;
                }
                
                // 创建卡片
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-4 card-hover border-l-4 ' + (instrument.status === 'normal' ? 'border-primary' : instrument.status === 'maintenance' ? 'border-warning' : 'border-danger');
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${instrument.name}</h3>
                            <p class="text-sm text-gray-600">编码: ${instrument.code}</p>
                        </div>
                        <div class="flex items-center">
                            <span class="status-badge ${statusClass}"></span>
                            <span class="text-sm">${statusText}</span>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">房间号:</span>
                            <span class="font-medium">${instrument.roomNumber}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">下次维护:</span>
                            <span class="font-medium ${daysUntilMaintenance !== null && daysUntilMaintenance < 0 ? 'text-red-500' : daysUntilMaintenance !== null && daysUntilMaintenance <= 20 ? 'text-warning' : ''}">
                                ${nextMaintenanceDate ? formatDate(nextMaintenanceDate) : '无'}
                                ${daysUntilMaintenance !== null ? ` (${daysUntilMaintenance < 0 ? '已逾期' : daysUntilMaintenance === 0 ? '今天' : daysUntilMaintenance + '天'})` : ''}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">维护类型:</span>
                            <span class="font-medium">${maintenanceType || '无'}</span>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between">
                        <button class="view-instrument-btn text-primary hover:text-primary-dark text-sm flex items-center" data-id="${instrument.id}">
                            <i class="fa fa-eye mr-1"></i> 查看详情
                        </button>
                        ${instrument.status === 'normal' && daysUntilMaintenance !== null && instrument.maintenanceRecords.length > 0 && canCompleteMaintenance(instrument.maintenanceRecords[0].nextMaintenance) ? `
                            <button class="complete-maintenance-btn btn-success text-xs" data-id="${instrument.id}">
                                一键完成维护
                            </button>
                        ` : ''}
                    </div>
                `;
                
                instrumentCardsContainer.appendChild(card);
                
                // 绑定查看详情按钮事件
                card.querySelector('.view-instrument-btn').addEventListener('click', function() {
                    const instrumentId = this.getAttribute('data-id');
                    showInstrumentDetail(instrumentId);
                });
                
                // 绑定一键完成维护按钮事件
                const completeBtn = card.querySelector('.complete-maintenance-btn');
                if (completeBtn) {
                    completeBtn.addEventListener('click', function() {
                        const instrumentId = this.getAttribute('data-id');
                        completeMaintenance(instrumentId);
                    });
                }
            });
        }

        // 显示仪器详情
        function showInstrumentDetail(instrumentId) {
            const instrument = instrumentsData.instruments.find(ins => ins.id === instrumentId);
            
            if (!instrument) return;
            
            currentInstrumentId = instrumentId;
            
            // 确定状态标签样式
            let statusClass = '';
            let statusText = '';
            
            switch (instrument.status) {
                case 'normal':
                    statusClass = 'status-normal';
                    statusText = '正常';
                    break;
                case 'maintenance':
                    statusClass = 'status-maintenance';
                    statusText = '维修中';
                    break;
                case 'disabled':
                    statusClass = 'status-disabled';
                    statusText = '停用';
                    break;
            }
            
            // 渲染仪器详情
            const detailContent = document.getElementById('instrument-detail-content');
            detailContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">基本信息</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">仪器编码:</span>
                                <span class="font-medium">${instrument.code}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">仪器名称:</span>
                                <span class="font-medium">${instrument.name}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">房间号:</span>
                                <span class="font-medium">${instrument.roomNumber}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">状态:</span>
                                <span class="font-medium flex items-center">
                                    <span class="status-badge ${statusClass}"></span>
                                    ${statusText}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">创建时间:</span>
                                <span class="font-medium">${formatDateTime(new Date(instrument.createdAt))}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">更新时间:</span>
                                <span class="font-medium">${formatDateTime(new Date(instrument.updatedAt))}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-center">
                        <img src="https://p26-doubao-search-sign.byteimg.com/tos-cn-i-be4g95zd3a/1068669570857435182~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1776822334&x-signature=qqVlTLPwA30xLYHE6p5qcF4KU%2FA%3D" alt="实验室仪器" class="h-40">
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">维护记录</h3>
                        ${currentUser.role === 'admin' ? `
                            <button id="edit-instrument-from-detail" class="btn-primary text-sm flex items-center" data-id="${instrument.id}">
                                <i class="fa fa-pencil mr-1"></i> 编辑仪器
                            </button>
                        ` : ''}
                    </div>
                    
                    ${instrument.maintenanceRecords.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">维护类型</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">维护内容</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">维护周期 (天)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">上次维护</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">下次维护</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">完成人</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${instrument.maintenanceRecords.map((record, index) => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${record.type}</td>
                                            <td class="px-6 py-4">${record.content}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${record.cycle}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${record.lastMaintenance || '无'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap ${new Date(record.nextMaintenance) < new Date() ? 'text-red-500 font-medium' : ''}">${record.nextMaintenance}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${record.completedBy}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                ${instrument.status === 'normal' ? `
                                                    <button class="complete-record-btn text-xs px-2 py-1 rounded text-white font-medium transition-all duration-200 ${canCompleteMaintenance(record.nextMaintenance) ? 'bg-green-500 hover:bg-green-600 cursor-pointer' : 'bg-gray-400 cursor-not-allowed'}" 
                                                            data-instrument-id="${instrument.id}" 
                                                            data-record-index="${index}">
                                                        ${canCompleteMaintenance(record.nextMaintenance) ? '完成维护' : '未到维护时间'}
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fa fa-info-circle text-2xl mb-2"></i>
                            <p>没有维护记录</p>
                        </div>
                    `}
                </div>
            `;
            
            // 绑定编辑仪器按钮事件
            const editBtn = detailContent.querySelector('#edit-instrument-from-detail');
            if (editBtn) {
                editBtn.addEventListener('click', function() {
                    const instrumentId = this.getAttribute('data-id');
                    openEditInstrumentModal(instrumentId);
                    document.getElementById('instrument-detail-modal').classList.add('hidden');
                });
            }
            
            // 绑定完成维护按钮事件
            detailContent.querySelectorAll('.complete-record-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const instrumentId = this.getAttribute('data-instrument-id');
                    const recordIndex = parseInt(this.getAttribute('data-record-index'));
                    completeRecordMaintenance(instrumentId, recordIndex);
                });
            });
            
            // 显示弹窗
            document.getElementById('instrument-detail-modal').classList.remove('hidden');
        }

        // 判断是否可以完成维护（下次维护日期到来前20天内）
        function canCompleteMaintenance(nextMaintenanceDate) {
            const today = new Date();
            const nextDate = new Date(nextMaintenanceDate);
            
            // 计算下次维护日期与今天的差值（天）
            const diffTime = nextDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // 如果差值小于等于20天且大于等于0天，则可以完成维护
            return diffDays >= 0 && diffDays <= 20;
        }
        
        // 显示自定义弹窗
        function showModal(title, message, confirmText = '确定', cancelText = '取消', confirmCallback = null, cancelCallback = null) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirm = document.getElementById('modal-confirm');
            const modalCancel = document.getElementById('modal-cancel');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirm.textContent = confirmText;
            modalCancel.textContent = cancelText;
            
            // 清除之前的事件监听
            const newConfirm = modalConfirm.cloneNode(true);
            const newCancel = modalCancel.cloneNode(true);
            modalConfirm.parentNode.replaceChild(newConfirm, modalConfirm);
            modalCancel.parentNode.replaceChild(newCancel, modalCancel);
            
            // 添加新的事件监听
            newConfirm.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                modal.classList.add('hidden');
            });
            
            newCancel.addEventListener('click', () => {
                if (typeof cancelCallback === 'function') {
                    cancelCallback();
                }
                modal.classList.add('hidden');
            });
            
            // 点击外部关闭弹窗
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            modal.classList.remove('hidden');
        }
        
        // 一键完成维护（针对整个仪器的最近维护记录）
        function completeMaintenance(instrumentId) {
            const instrument = instrumentsData.instruments.find(ins => ins.id === instrumentId);
            
            if (!instrument) return;
            
            // 获取最近的维护记录
            let nearestRecord = null;
            let nearestDate = null;
            let nearestIndex = -1;
            
            instrument.maintenanceRecords.forEach(function(record, index) {
                const nextDate = new Date(record.nextMaintenance);
                if (!nearestDate || nextDate < nearestDate) {
                    nearestDate = nextDate;
                    nearestRecord = record;
                    nearestIndex = index;
                }
            });
            
            if (!nearestRecord) return;
            
            // 检查是否可以完成维护
            if (!canCompleteMaintenance(nearestRecord.nextMaintenance)) {
                alert('当前不在维护窗口期内，无法完成维护。');
                return;
            }
            
            // 更新维护记录
            const today = new Date();
            nearestRecord.lastMaintenance = formatDate(today);
            nearestRecord.completedBy = currentUser.username;
            nearestRecord.completedAt = today.toISOString();
            
            // 计算下次维护时间（从当前下次维护日期加上维护周期）
            const nextMaintenanceDate = new Date(nearestRecord.nextMaintenance);
            nextMaintenanceDate.setDate(nextMaintenanceDate.getDate() + nearestRecord.cycle);
            nearestRecord.nextMaintenance = formatDate(nextMaintenanceDate);
            
            // 更新仪器更新时间
            instrument.updatedAt = today.toISOString();
            
            // 保存数据
            saveData('instrumentData', instrumentsData);
            
            // 重新渲染仪表盘
            renderDashboard();
            
            // 显示成功消息
            alert('维护完成！下次维护时间已更新。');
            
            // 添加审计日志（包含数据快照）
            const instrumentSnapshot = JSON.parse(JSON.stringify(instrumentsData));
            addAuditLog(currentUser.username, 'complete_maintenance', `完成仪器 ${instrument.name} (${instrument.code}) 的维护`, instrumentSnapshot);
        }
        
        // 完成单个维护记录的维护
        function completeRecordMaintenance(instrumentId, recordIndex) {
            const instrument = instrumentsData.instruments.find(ins => ins.id === instrumentId);
            
            if (!instrument || !instrument.maintenanceRecords[recordIndex]) return;
            
            const record = instrument.maintenanceRecords[recordIndex];
            
            // 检查是否可以完成维护
            if (!canCompleteMaintenance(record.nextMaintenance)) {
                // 显示未到维护时间提示
                const modal = document.getElementById('custom-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalConfirm = document.getElementById('modal-confirm');
                const modalCancel = document.getElementById('modal-cancel');
                
                modalTitle.textContent = '提示';
                modalMessage.textContent = '当前不在维护窗口期内，无法完成维护。';
                modalConfirm.textContent = '我知道了';
                modalCancel.textContent = '';
                modalCancel.style.display = 'none';
                
                // 清除之前的事件监听
                const newConfirm = modalConfirm.cloneNode(true);
                modalConfirm.parentNode.replaceChild(newConfirm, modalConfirm);
                
                // 添加新的事件监听
                newConfirm.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
                
                // 点击外部关闭弹窗
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
                
                modal.classList.remove('hidden');
                return;
            }
            
            // 确认是否完成维护
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirm = document.getElementById('modal-confirm');
            const modalCancel = document.getElementById('modal-cancel');
            
            modalTitle.textContent = '确认完成维护';
            modalMessage.textContent = `您确定要完成 "${record.type}" 的维护吗？`;
            modalConfirm.textContent = '确认';
            modalCancel.textContent = '取消';
            modalCancel.style.display = 'block';
            
            // 清除之前的事件监听
            const newConfirm = modalConfirm.cloneNode(true);
            const newCancel = modalCancel.cloneNode(true);
            modalConfirm.parentNode.replaceChild(newConfirm, modalConfirm);
            modalCancel.parentNode.replaceChild(newCancel, modalCancel);
            
            // 添加新的事件监听
            newConfirm.addEventListener('click', () => {
                // 更新维护记录
                const today = new Date();
                record.lastMaintenance = formatDate(today);
                record.completedBy = currentUser.username;
                record.completedAt = today.toISOString();
                
                // 计算下次维护时间（从当前下次维护日期加上维护周期）
                const nextMaintenanceDate = new Date(record.nextMaintenance);
                nextMaintenanceDate.setDate(nextMaintenanceDate.getDate() + record.cycle);
                record.nextMaintenance = formatDate(nextMaintenanceDate);
                
                // 更新仪器更新时间
                instrument.updatedAt = today.toISOString();
                
                // 保存数据
                saveData('instrumentData', instrumentsData);
                
                // 重新显示仪器详情
                showInstrumentDetail(instrumentId);
                
                // 重新渲染仪表盘和仪器列表
                renderDashboard();
                renderInstrumentList();
                
                // 显示成功消息
                modalTitle.textContent = '维护完成';
                modalMessage.textContent = '维护已完成！下次维护时间已更新。';
                modalConfirm.textContent = '确定';
                modalCancel.style.display = 'none';
                
                // 清除之前的事件监听
                const successConfirm = newConfirm.cloneNode(true);
                newConfirm.parentNode.replaceChild(successConfirm, newConfirm);
                
                // 添加新的事件监听
                successConfirm.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
                
                // 添加审计日志（包含数据快照）
                const instrumentSnapshot = JSON.parse(JSON.stringify(instrumentsData));
                addAuditLog(currentUser.username, 'complete_record_maintenance', `完成仪器 ${instrument.name} (${instrument.code}) 的 "${record.type}" 维护`, instrumentSnapshot);
            });
            
            newCancel.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            
            // 点击外部关闭弹窗
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            modal.classList.remove('hidden');
        }

        // 渲染仪器列表
        function renderInstrumentList() {
            const searchTerm = document.getElementById('instrument-search').value.toLowerCase();
            const statusFilter = document.getElementById('instrument-filter-status').value;
            const roomFilter = document.getElementById('instrument-filter-room').value;
            const maintenanceFilter = document.getElementById('instrument-filter-maintenance').value;
            
            // 筛选仪器
            let filteredInstruments = instrumentsData.instruments;
            
            if (searchTerm) {
                filteredInstruments = filteredInstruments.filter(instrument => 
                    instrument.name.toLowerCase().includes(searchTerm) || 
                    instrument.code.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredInstruments = filteredInstruments.filter(instrument => instrument.status === statusFilter);
            }
            
            if (roomFilter) {
                filteredInstruments = filteredInstruments.filter(instrument => instrument.roomNumber.toLowerCase().includes(roomFilter.toLowerCase()));
            }
            
            if (maintenanceFilter) {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const nextMonth = (currentMonth + 1) % 12;
                const nextMonthYear = nextMonth === 0 ? currentYear + 1 : currentYear;
                
                filteredInstruments = filteredInstruments.filter(instrument => {
                    let match = false;
                    
                    instrument.maintenanceRecords.forEach(function(record) {
                        const nextMaintenanceDate = new Date(record.nextMaintenance);
                        
                        switch (maintenanceFilter) {
                            case 'this_month':
                                if (nextMaintenanceDate.getMonth() === currentMonth && nextMaintenanceDate.getFullYear() === currentYear) {
                                    match = true;
                                }
                                break;
                            case 'next_month':
                                if (nextMaintenanceDate.getMonth() === nextMonth && nextMaintenanceDate.getFullYear() === nextMonthYear) {
                                    match = true;
                                }
                                break;
                            case 'overdue':
                                if (nextMaintenanceDate < today) {
                                    match = true;
                                }
                                break;
                            case 'maintainable':
                                // 可维护：下次维护日期前20天内
                                const twentyDaysLater = new Date();
                                twentyDaysLater.setDate(today.getDate() + 20);
                                if (nextMaintenanceDate >= today && nextMaintenanceDate <= twentyDaysLater) {
                                    match = true;
                                }
                                break;
                        }
                    });
                    
                    return match;
                });
            }
            
            // 渲染列表
            const instrumentListContainer = document.getElementById('instrument-list');
            instrumentListContainer.innerHTML = '';
            
            if (filteredInstruments.length === 0) {
                document.getElementById('no-instrument-list-message').classList.remove('hidden');
                document.getElementById('instrument-count').textContent = '0';
                return;
            }
            
            document.getElementById('no-instrument-list-message').classList.add('hidden');
            document.getElementById('instrument-count').textContent = filteredInstruments.length;
            
            filteredInstruments.forEach(function(instrument) {
                // 获取最近的维护记录
                let nextMaintenanceDate = null;
                
                if (instrument.maintenanceRecords.length > 0) {
                    // 按下次维护时间排序
                    const sortedRecords = [...instrument.maintenanceRecords].sort((a, b) => {
                        return new Date(a.nextMaintenance) - new Date(b.nextMaintenance);
                    });
                    
                    nextMaintenanceDate = sortedRecords[0].nextMaintenance;
                }
                
                // 确定状态标签样式
                let statusClass = '';
                let statusText = '';
                
                switch (instrument.status) {
                    case 'normal':
                        statusClass = 'status-normal';
                        statusText = '正常';
                        break;
                    case 'maintenance':
                        statusClass = 'status-maintenance';
                        statusText = '维修中';
                        break;
                    case 'disabled':
                        statusClass = 'status-disabled';
                        statusText = '停用';
                        break;
                }
                
                // 创建列表项
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${instrument.code}</td>
                    <td class="px-6 py-4">${instrument.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${instrument.roomNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="flex items-center">
                            <span class="status-badge ${statusClass}"></span>
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap ${nextMaintenanceDate && new Date(nextMaintenanceDate) < new Date() ? 'text-red-500 font-medium' : ''}">
                        ${nextMaintenanceDate || '无'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end space-x-2">
                            <button class="view-instrument-list-btn text-primary hover:text-primary-dark" data-id="${instrument.id}">
                                查看
                            </button>
                            ${currentUser.role === 'admin' ? `
                                <button class="edit-instrument-list-btn text-secondary hover:text-secondary-dark" data-id="${instrument.id}">
                                    编辑
                                </button>
                                <button class="delete-instrument-btn text-danger hover:text-red-700" data-id="${instrument.id}">
                                    删除
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                instrumentListContainer.appendChild(row);
                
                // 绑定查看按钮事件
                row.querySelector('.view-instrument-list-btn').addEventListener('click', function() {
                    const instrumentId = this.getAttribute('data-id');
                    showInstrumentDetail(instrumentId);
                });
                
                // 绑定编辑按钮事件
                const editBtn = row.querySelector('.edit-instrument-list-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        const instrumentId = this.getAttribute('data-id');
                        openEditInstrumentModal(instrumentId);
                    });
                }
                
                // 绑定删除按钮事件
                const deleteBtn = row.querySelector('.delete-instrument-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        const instrumentId = this.getAttribute('data-id');
                        const instrument = instrumentsData.instruments.find(ins => ins.id === instrumentId);
                        
                        if (instrument) {
                            document.getElementById('delete-confirmation-message').textContent = `您确定要删除仪器 "${instrument.name}" (${instrument.code}) 吗？此操作不可撤销。`;
                            document.getElementById('confirm-delete-modal').classList.remove('hidden');
                            
                            deleteCallback = function() {
                                deleteInstrument(instrumentId);
                            };
                        }
                    });
                }
            });
        }

        // 打开添加仪器弹窗
        function openAddInstrumentModal() {
            // 重置表单
            document.getElementById('instrument-form').reset();
            document.getElementById('instrument-id').value = '';
            document.getElementById('instrument-edit-title').textContent = '添加仪器';
            
            // 清空维护记录
            const maintenanceRecordsContainer = document.getElementById('maintenance-records');
            maintenanceRecordsContainer.innerHTML = `
                <div class="maintenance-record bg-gray-50 p-4 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">维护类型</label>
                            <input type="text" class="maintenance-type input-field w-full" placeholder="请输入维护类型">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">维护内容</label>
                            <input type="text" class="maintenance-content input-field w-full" placeholder="请输入维护内容">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">维护周期 (天)</label>
                            <input type="number" class="maintenance-cycle input-field w-full" placeholder="请输入维护周期">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">下次维护时间</label>
                            <input type="date" class="maintenance-next input-field w-full">
                        </div>
                    </div>
                </div>
            `;
            
            // 显示弹窗
            document.getElementById('instrument-edit-modal').classList.remove('hidden');
        }

        // 打开编辑仪器弹窗
        function openEditInstrumentModal(instrumentId) {
            const instrument = instrumentsData.instruments.find(ins => ins.id === instrumentId);
            
            if (!instrument) return;
            
            // 填充表单
            document.getElementById('instrument-id').value = instrument.id;
            document.getElementById('edit-instrument-code').value = instrument.code;
            document.getElementById('edit-instrument-name').value = instrument.name;
            document.getElementById('edit-instrument-room').value = instrument.roomNumber;
            document.getElementById('edit-instrument-status').value = instrument.status;
            document.getElementById('instrument-edit-title').textContent = '编辑仪器';
            
            // 填充维护记录
            const maintenanceRecordsContainer = document.getElementById('maintenance-records');
            maintenanceRecordsContainer.innerHTML = '';
            
            if (instrument.maintenanceRecords.length > 0) {
                instrument.maintenanceRecords.forEach(function(record, index) {
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'maintenance-record bg-gray-50 p-4 rounded-md';
                    recordDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-800">维护记录 ${index + 1}</h4>
                            ${index > 0 ? `
                                <button class="remove-maintenance-record text-red-500 hover:text-red-700" data-index="${index}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">维护类型</label>
                                <input type="text" class="maintenance-type input-field w-full" value="${record.type}" placeholder="请输入维护类型">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">维护内容</label>
                                <input type="text" class="maintenance-content input-field w-full" value="${record.content}" placeholder="请输入维护内容">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">维护周期 (天)</label>
                                <input type="number" class="maintenance-cycle input-field w-full" value="${record.cycle}" placeholder="请输入维护周期">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">下次维护时间</label>
                                <input type="date" class="maintenance-next input-field w-full" value="${record.nextMaintenance}">
                            </div>
                        </div>
                    `;
                    
                    maintenanceRecordsContainer.appendChild(recordDiv);
                });
            } else {
                maintenanceRecordsContainer.innerHTML = `
                    <div class="maintenance-record bg-gray-50 p-4 rounded-md">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">维护类型</label>
                                <input type="text" class="maintenance-type input-field w-full" placeholder="请输入维护类型">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">维护内容</label>
                                <input type="text" class="maintenance-content input-field w-full" placeholder="请输入维护内容">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">维护周期 (天)</label>
                                <input type="number" class="maintenance-cycle input-field w-full" placeholder="请输入维护周期">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">下次维护时间</label>
                                <input type="date" class="maintenance-next input-field w-full">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 绑定删除维护记录按钮事件
            document.querySelectorAll('.remove-maintenance-record').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const recordDiv = this.closest('.maintenance-record');
                    recordDiv.remove();
                });
            });
            
            // 显示弹窗
            document.getElementById('instrument-edit-modal').classList.remove('hidden');
        }

        // 添加维护记录
        function addMaintenanceRecord() {
            const maintenanceRecordsContainer = document.getElementById('maintenance-records');
            const recordCount = maintenanceRecordsContainer.children.length;
            
            const recordDiv = document.createElement('div');
            recordDiv.className = 'maintenance-record bg-gray-50 p-4 rounded-md';
            recordDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-medium text-gray-800">维护记录 ${recordCount + 1}</h4>
                    <button class="remove-maintenance-record text-red-500 hover:text-red-700">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">维护类型</label>
                        <input type="text" class="maintenance-type input-field w-full" placeholder="请输入维护类型">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">维护内容</label>
                        <input type="text" class="maintenance-content input-field w-full" placeholder="请输入维护内容">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">维护周期 (天)</label>
                        <input type="number" class="maintenance-cycle input-field w-full" placeholder="请输入维护周期">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">下次维护时间</label>
                        <input type="date" class="maintenance-next input-field w-full">
                    </div>
                </div>
            `;
            
            maintenanceRecordsContainer.appendChild(recordDiv);
            
            // 绑定删除维护记录按钮事件
            recordDiv.querySelector('.remove-maintenance-record').addEventListener('click', function() {
                recordDiv.remove();
            });
        }

        // 保存仪器
        function saveInstrument() {
            const instrumentId = document.getElementById('instrument-id').value;
            const code = document.getElementById('edit-instrument-code').value;
            const name = document.getElementById('edit-instrument-name').value;
            const roomNumber = document.getElementById('edit-instrument-room').value;
            const status = document.getElementById('edit-instrument-status').value;
            
            // 收集维护记录
            const maintenanceRecords = [];
            const recordDivs = document.querySelectorAll('.maintenance-record');
            
            recordDivs.forEach(function(div) {
                const type = div.querySelector('.maintenance-type').value;
                const content = div.querySelector('.maintenance-content').value;
                const cycle = parseInt(div.querySelector('.maintenance-cycle').value);
                const nextMaintenance = div.querySelector('.maintenance-next').value;
                
                if (type && content && !isNaN(cycle) && nextMaintenance) {
                    maintenanceRecords.push({
                        type,
                        content,
                        cycle,
                        nextMaintenance,
                        lastMaintenance: null,
                        completedBy: null,
                        completedAt: null
                    });
                }
            });
            
            // 验证必填字段
            if (!code || !name || !roomNumber || !status) {
                alert('请填写所有必填字段');
                return;
            }
            
            // 验证仪器编码是否已存在（添加新仪器时）
            if (!instrumentId && instrumentsData.instruments.some(ins => ins.code === code)) {
                alert('仪器编码已存在');
                return;
            }
            
            const today = new Date();
            
            if (instrumentId) {
                // 编辑现有仪器
                const instrument = instrumentsData.instruments.find(ins => ins.id === instrumentId);
                
                if (instrument) {
                    instrument.code = code;
                    instrument.name = name;
                    instrument.roomNumber = roomNumber;
                    instrument.status = status;
                    instrument.maintenanceRecords = maintenanceRecords;
                    instrument.updatedAt = today.toISOString();
                    
                    // 保存数据
                    saveData('instrumentData', instrumentsData);
                    
                    // 重新渲染列表
                    renderInstrumentList();
                    
                    // 关闭弹窗
                    document.getElementById('instrument-edit-modal').classList.add('hidden');
                    
                    // 显示成功消息
                    alert('仪器信息已更新');
                    
                    // 添加审计日志（包含数据快照）
                    const instrumentSnapshot = JSON.parse(JSON.stringify(instrumentsData));
                    addAuditLog(currentUser.username, 'update_instrument', `更新仪器 ${instrument.name} (${instrument.code})`, instrumentSnapshot);
                }
            } else {
                // 添加新仪器
                const newInstrument = {
                    id: 'INS' + Date.now().toString().slice(-6),
                    code,
                    name,
                    roomNumber,
                    status,
                    maintenanceRecords,
                    createdAt: today.toISOString(),
                    updatedAt: today.toISOString()
                };
                
                instrumentsData.instruments.push(newInstrument);
                
                // 保存数据
                saveData('instrumentData', instrumentsData);
                
                // 重新渲染列表
                renderInstrumentList();
                
                // 关闭弹窗
                document.getElementById('instrument-edit-modal').classList.add('hidden');
                
                // 显示成功消息
                alert('仪器已添加');
                
                // 添加审计日志（包含数据快照）
                const instrumentSnapshot = JSON.parse(JSON.stringify(instrumentsData));
                addAuditLog(currentUser.username, 'add_instrument', `添加新仪器 ${newInstrument.name} (${newInstrument.code})`, instrumentSnapshot);
            }
        }

        // 删除仪器
        function deleteInstrument(instrumentId) {
            const index = instrumentsData.instruments.findIndex(ins => ins.id === instrumentId);
            
            if (index !== -1) {
                const instrument = instrumentsData.instruments[index];
                
                // 从数组中删除仪器
                instrumentsData.instruments.splice(index, 1);
                
                // 保存数据
                saveData('instrumentData', instrumentsData);
                
                // 重新渲染列表
                renderInstrumentList();
                
                // 显示成功消息
                alert('仪器已删除');
                
                // 添加审计日志（包含数据快照）
                const instrumentSnapshot = JSON.parse(JSON.stringify(instrumentsData));
                addAuditLog(currentUser.username, 'delete_instrument', `删除仪器 ${instrument.name} (${instrument.code})`, instrumentSnapshot);
            }
        }

        // 下载仪器导入模板
        function downloadInstrumentTemplate() {
            // CSV模板内容
            const templateContent = [
                // 标题行
                "仪器编码,仪器名称,房间号,维护类型,维护内容,维护周期(天),下次维护时间",
                // 示例数据行
                "INS001,电子天平,101,校准,年度校准,365,2025-12-31",
                "INS002,pH计,102,校准,季度校准,90,2025-09-30",
                "INS003,紫外分光光度计,103,校准,半年校准,180,2025-12-31"
            ].join("\n");
            
            // 添加UTF-8 BOM以解决中文乱码问题
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, templateContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // 设置下载属性
            link.setAttribute('href', url);
            link.setAttribute('download', '仪器导入模板.csv');
            link.style.visibility = 'hidden';
            
            // 添加到DOM并触发点击
            document.body.appendChild(link);
            link.click();
            
            // 清理
            document.body.removeChild(link);
        }
        
        // 导入仪器信息
        function importInstruments(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const contents = e.target.result;
                const lines = contents.split('\n');
                
                // 跳过标题行
                let importedCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (!line) continue;
                    
                    const values = line.split(',');
                    
                    // 简单验证CSV格式
                    if (values.length < 7) continue;
                    
                    const code = values[0].trim();
                    const name = values[1].trim();
                    const roomNumber = values[2].trim();
                    const maintenanceType = values[3].trim();
                    const maintenanceContent = values[4].trim();
                    const maintenanceCycle = parseInt(values[5].trim());
                    const nextMaintenance = values[6].trim();
                    
                    // 验证数据
                    if (!code || !name || !roomNumber || !maintenanceType || !maintenanceContent || isNaN(maintenanceCycle) || !nextMaintenance) {
                        continue;
                    }
                    
                    // 检查仪器编码是否已存在
                    const existingInstrument = instrumentsData.instruments.find(ins => ins.code === code);
                    
                    if (existingInstrument) {
                        // 更新现有仪器
                        existingInstrument.name = name;
                        existingInstrument.roomNumber = roomNumber;
                        
                        // 检查维护类型是否已存在
                        const maintenanceIndex = existingInstrument.maintenanceRecords.findIndex(record => record.type === maintenanceType);
                        
                        if (maintenanceIndex !== -1) {
                            // 更新现有维护记录
                            existingInstrument.maintenanceRecords[maintenanceIndex] = {
                                ...existingInstrument.maintenanceRecords[maintenanceIndex],
                                content: maintenanceContent,
                                cycle: maintenanceCycle,
                                nextMaintenance
                            };
                        } else {
                            // 添加新的维护记录
                            existingInstrument.maintenanceRecords.push({
                                type: maintenanceType,
                                content: maintenanceContent,
                                cycle: maintenanceCycle,
                                nextMaintenance,
                                lastMaintenance: null,
                                completedBy: null,
                                completedAt: null
                            });
                        }
                        
                        existingInstrument.updatedAt = new Date().toISOString();
                    } else {
                        // 添加新仪器
                        const newInstrument = {
                            id: 'INS' + Date.now().toString().slice(-6) + i,
                            code,
                            name,
                            roomNumber,
                            status: 'normal',
                            maintenanceRecords: [
                                {
                                    type: maintenanceType,
                                    content: maintenanceContent,
                                    cycle: maintenanceCycle,
                                    nextMaintenance,
                                    lastMaintenance: null,
                                    completedBy: null,
                                    completedAt: null
                                }
                            ],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        instrumentsData.instruments.push(newInstrument);
                    }
                    
                    importedCount++;
                }
                
                // 保存数据
                saveData('instrumentData', instrumentsData);
                
                // 重新渲染列表
                renderInstrumentList();
                
                // 关闭弹窗
                document.getElementById('import-instruments-modal').classList.add('hidden');
                
                // 重置文件输入
                document.getElementById('import-file').value = '';
                document.getElementById('import-file-name').classList.add('hidden');
                
                // 显示成功消息
                alert(`成功导入 ${importedCount} 条仪器记录`);
                
                // 添加审计日志
                addAuditLog(currentUser.username, 'import_instruments', `导入 ${importedCount} 条仪器记录`);
            };
            
            reader.onerror = function() {
                alert('读取文件时出错');
            };
            
            reader.readAsText(file);
        }

        // 渲染会议纪要列表
        function renderMeetingList() {
            const searchTerm = document.getElementById('meeting-search').value.toLowerCase();
            
            // 筛选会议纪要
            let filteredMeetings = meetingData.meetings;
            
            if (searchTerm) {
                filteredMeetings = filteredMeetings.filter(meeting => 
                    meeting.title.toLowerCase().includes(searchTerm) || 
                    meeting.content.toLowerCase().includes(searchTerm)
                );
            }
            
            // 按创建时间排序
            filteredMeetings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // 渲染列表
            const meetingListContainer = document.getElementById('meeting-list');
            meetingListContainer.innerHTML = '';
            
            if (filteredMeetings.length === 0) {
                document.getElementById('no-meetings-message').classList.remove('hidden');
                return;
            }
            
            document.getElementById('no-meetings-message').classList.add('hidden');
            
            filteredMeetings.forEach(function(meeting) {
                // 创建列表项
                const item = document.createElement('div');
                item.className = 'bg-white rounded-lg shadow-sm p-4 border border-gray-100';
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-gray-800">${meeting.title}</h3>
                        <div class="text-sm text-gray-500">${formatDateTime(new Date(meeting.createdAt))}</div>
                    </div>
                    <div class="text-gray-600 mb-4">${stripHtmlTags(meeting.content).substring(0, 100)}${meeting.content.length > 100 ? '...' : ''}</div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">创建人: ${meeting.createdBy}</div>
                        <div class="flex space-x-2">
                            <button class="view-meeting-btn text-primary hover:text-primary-dark text-sm" data-id="${meeting.id}">
                                查看
                            </button>
                            ${currentUser.role === 'admin' ? `
                                <button class="edit-meeting-btn text-secondary hover:text-secondary-dark text-sm" data-id="${meeting.id}">
                                    编辑
                                </button>
                                <button class="delete-meeting-btn text-danger hover:text-red-700 text-sm" data-id="${meeting.id}">
                                    删除
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                meetingListContainer.appendChild(item);
                
                // 绑定查看按钮事件
                item.querySelector('.view-meeting-btn').addEventListener('click', function() {
                    const meetingId = this.getAttribute('data-id');
                    viewMeeting(meetingId);
                });
                
                // 绑定编辑按钮事件
                const editBtn = item.querySelector('.edit-meeting-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        const meetingId = this.getAttribute('data-id');
                        editMeeting(meetingId);
                    });
                }
                
                // 绑定删除按钮事件
                const deleteBtn = item.querySelector('.delete-meeting-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        const meetingId = this.getAttribute('data-id');
                        const meeting = meetingData.meetings.find(m => m.id === meetingId);
                        
                        if (meeting) {
                            document.getElementById('delete-confirmation-message').textContent = `您确定要删除会议纪要 "${meeting.title}" 吗？此操作不可撤销。`;
                            document.getElementById('confirm-delete-modal').classList.remove('hidden');
                            
                            deleteCallback = function() {
                                deleteMeeting(meetingId);
                            };
                        }
                    });
                }
            });
        }

        // 查看会议纪要
        function viewMeeting(meetingId) {
            const meeting = meetingData.meetings.find(m => m.id === meetingId);
            
            if (!meeting) return;
            
            // 填充编辑器
            document.getElementById('meeting-title').value = meeting.title;
            document.getElementById('meeting-content').innerHTML = meeting.content;
            
            // 禁用编辑器
            document.getElementById('meeting-title').disabled = true;
            document.getElementById('meeting-content').contentEditable = false;
            
            // 隐藏保存按钮
            document.getElementById('save-meeting').classList.add('hidden');
            
            // 设置当前会议ID
            currentMeetingId = meetingId;
            
            // 显示弹窗
            document.getElementById('add-meeting-modal').classList.remove('hidden');
        }

        // 编辑会议纪要
        function editMeeting(meetingId) {
            const meeting = meetingData.meetings.find(m => m.id === meetingId);
            
            if (!meeting) return;
            
            // 填充编辑器
            document.getElementById('meeting-title').value = meeting.title;
            document.getElementById('meeting-content').innerHTML = meeting.content;
            
            // 启用编辑器
            document.getElementById('meeting-title').disabled = false;
            document.getElementById('meeting-content').contentEditable = true;
            
            // 显示保存按钮
            document.getElementById('save-meeting').classList.remove('hidden');
            
            // 设置当前会议ID
            currentMeetingId = meetingId;
            
            // 显示弹窗
            document.getElementById('add-meeting-modal').classList.remove('hidden');
        }

        // 保存会议纪要
        function saveMeeting() {
            const title = document.getElementById('meeting-title').value;
            const content = document.getElementById('meeting-content').innerHTML;
            
            // 验证必填字段
            if (!title || !content) {
                alert('请填写主题和内容');
                return;
            }
            
            const today = new Date();
            
            if (currentMeetingId) {
                // 编辑现有会议纪要
                const meeting = meetingData.meetings.find(m => m.id === currentMeetingId);
                
                if (meeting) {
                    meeting.title = title;
                    meeting.content = content;
                    meeting.updatedAt = today.toISOString();
                    
                    // 保存数据
                    saveData('meetingData', meetingData);
                    
                    // 重新渲染列表
                    renderMeetingList();
                    
                    // 显示成功消息
                    document.getElementById('save-status').textContent = '保存成功';
                    document.getElementById('save-status').classList.remove('text-gray-500');
                    document.getElementById('save-status').classList.add('text-green-500');
                    
                    setTimeout(function() {
                        document.getElementById('save-status').textContent = '自动保存中...';
                        document.getElementById('save-status').classList.remove('text-green-500');
                        document.getElementById('save-status').classList.add('text-gray-500');
                    }, 2000);
                    
                    // 添加审计日志
                    addAuditLog(currentUser.username, 'update_meeting', `更新会议纪要 "${meeting.title}"`);
                }
            } else {
                // 添加新会议纪要
                const newMeeting = {
                    id: 'MEET' + Date.now().toString().slice(-6),
                    title,
                    content,
                    createdBy: currentUser.username,
                    createdAt: today.toISOString(),
                    updatedAt: today.toISOString()
                };
                
                meetingData.meetings.push(newMeeting);
                
                // 保存数据
                saveData('meetingData', meetingData);
                
                // 重新渲染列表
                renderMeetingList();
                
                // 清空编辑器
                document.getElementById('meeting-title').value = '';
                document.getElementById('meeting-content').innerHTML = '';
                
                // 显示成功消息
                document.getElementById('save-status').textContent = '保存成功';
                document.getElementById('save-status').classList.remove('text-gray-500');
                document.getElementById('save-status').classList.add('text-green-500');
                
                setTimeout(function() {
                    document.getElementById('save-status').textContent = '自动保存中...';
                    document.getElementById('save-status').classList.remove('text-green-500');
                    document.getElementById('save-status').classList.add('text-gray-500');
                }, 2000);
                
                // 添加审计日志
                addAuditLog(currentUser.username, 'add_meeting', `添加新会议纪要 "${newMeeting.title}"`);
            }
        }

        // 删除会议纪要
        function deleteMeeting(meetingId) {
            const index = meetingData.meetings.findIndex(m => m.id === meetingId);
            
            if (index !== -1) {
                const meeting = meetingData.meetings[index];
                
                // 从数组中删除会议纪要
                meetingData.meetings.splice(index, 1);
                
                // 保存数据
                saveData('meetingData', meetingData);
                
                // 重新渲染列表
                renderMeetingList();
                
                // 如果当前正在编辑或查看被删除的会议纪要，清空编辑器
                if (currentMeetingId === meetingId) {
                    document.getElementById('meeting-title').value = '';
                    document.getElementById('meeting-content').innerHTML = '';
                    currentMeetingId = null;
                }
                
                // 显示成功消息
                alert('会议纪要已删除');
                
                // 添加审计日志
                addAuditLog(currentUser.username, 'delete_meeting', `删除会议纪要 "${meeting.title}"`);
            }
        }

        // 渲染偏离记录列表
        function renderDeviationList() {
            const searchTerm = document.getElementById('deviation-search').value.toLowerCase();
            
            // 筛选偏离记录
            let filteredDeviations = deviationData.deviations;
            
            if (searchTerm) {
                filteredDeviations = filteredDeviations.filter(deviation => 
                    deviation.title.toLowerCase().includes(searchTerm) || 
                    deviation.content.toLowerCase().includes(searchTerm)
                );
            }
            
            // 按创建时间排序
            filteredDeviations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // 渲染列表
            const deviationListContainer = document.getElementById('deviation-list');
            deviationListContainer.innerHTML = '';
            
            if (filteredDeviations.length === 0) {
                document.getElementById('no-deviations-message').classList.remove('hidden');
                return;
            }
            
            document.getElementById('no-deviations-message').classList.add('hidden');
            
            filteredDeviations.forEach(function(deviation) {
                // 确定状态标签样式
                let statusClass = '';
                let statusText = '';
                
                switch (deviation.status) {
                    case 'pending':
                        statusClass = 'bg-warning text-white';
                        statusText = '待处理';
                        break;
                    case 'resolved':
                        statusClass = 'bg-success text-white';
                        statusText = '已解决';
                        break;
                }
                
                // 创建列表项
                const item = document.createElement('div');
                item.className = 'bg-white rounded-lg shadow-sm p-4 border border-gray-100';
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-gray-800">${deviation.title}</h3>
                        <div class="text-sm text-gray-500">${formatDateTime(new Date(deviation.createdAt))}</div>
                    </div>
                    <div class="text-gray-600 mb-4">${stripHtmlTags(deviation.content).substring(0, 100)}${deviation.content.length > 100 ? '...' : ''}</div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">创建人: ${deviation.createdBy}</div>
                        <div class="flex space-x-2">
                            <button class="view-deviation-btn text-primary hover:text-primary-dark text-sm" data-id="${deviation.id}">
                                查看
                            </button>
                            ${currentUser.role === 'admin' ? `
                                <button class="edit-deviation-btn text-secondary hover:text-secondary-dark text-sm" data-id="${deviation.id}">
                                    编辑
                                </button>
                                <button class="delete-deviation-btn text-danger hover:text-red-700 text-sm" data-id="${deviation.id}">
                                    删除
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                deviationListContainer.appendChild(item);
                
                // 绑定查看按钮事件
                item.querySelector('.view-deviation-btn').addEventListener('click', function() {
                    const deviationId = this.getAttribute('data-id');
                    viewDeviation(deviationId);
                });
                
                // 绑定编辑按钮事件
                const editBtn = item.querySelector('.edit-deviation-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        const deviationId = this.getAttribute('data-id');
                        editDeviation(deviationId);
                    });
                }
                
                // 绑定删除按钮事件
                const deleteBtn = item.querySelector('.delete-deviation-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        const deviationId = this.getAttribute('data-id');
                        const deviation = deviationData.deviations.find(d => d.id === deviationId);
                        
                        if (deviation) {
                            document.getElementById('delete-confirmation-message').textContent = `您确定要删除偏离记录 "${deviation.title}" 吗？此操作不可撤销。`;
                            document.getElementById('confirm-delete-modal').classList.remove('hidden');
                            
                            deleteCallback = function() {
                                deleteDeviation(deviationId);
                            };
                        }
                    });
                }
            });
        }

        // 查看偏离记录
        function viewDeviation(deviationId) {
            const deviation = deviationData.deviations.find(d => d.id === deviationId);
            
            if (!deviation) return;
            
            // 填充编辑器
            document.getElementById('deviation-title').value = deviation.title;
            document.getElementById('deviation-content').innerHTML = deviation.content;
            document.getElementById('deviation-status').value = deviation.status;
            
            // 禁用编辑器
            document.getElementById('deviation-title').disabled = true;
            document.getElementById('deviation-content').contentEditable = false;
            document.getElementById('deviation-status').disabled = true;
            
            // 隐藏保存按钮
            document.getElementById('save-deviation').classList.add('hidden');
            
            // 设置当前偏离记录ID
            currentDeviationId = deviationId;
            
            // 显示弹窗
            document.getElementById('add-deviation-modal').classList.remove('hidden');
        }

        // 编辑偏离记录
        function editDeviation(deviationId) {
            const deviation = deviationData.deviations.find(d => d.id === deviationId);
            
            if (!deviation) return;
            
            // 填充编辑器
            document.getElementById('deviation-title').value = deviation.title;
            document.getElementById('deviation-content').innerHTML = deviation.content;
            document.getElementById('deviation-status').value = deviation.status;
            
            // 启用编辑器
            document.getElementById('deviation-title').disabled = false;
            document.getElementById('deviation-content').contentEditable = true;
            document.getElementById('deviation-status').disabled = false;
            
            // 显示保存按钮
            document.getElementById('save-deviation').classList.remove('hidden');
            
            // 设置当前偏离记录ID
            currentDeviationId = deviationId;
            
            // 显示弹窗
            document.getElementById('add-deviation-modal').classList.remove('hidden');
        }

        // 保存偏离记录
        function saveDeviation() {
            const title = document.getElementById('deviation-title').value;
            const content = document.getElementById('deviation-content').innerHTML;
            const status = document.getElementById('deviation-status').value;
            
            // 验证必填字段
            if (!title || !content) {
                alert('请填写主题和内容');
                return;
            }
            
            const today = new Date();
            
            if (currentDeviationId) {
                // 编辑现有偏离记录
                const deviation = deviationData.deviations.find(d => d.id === currentDeviationId);
                
                if (deviation) {
                    deviation.title = title;
                    deviation.content = content;
                    deviation.status = status;
                    deviation.updatedAt = today.toISOString();
                    
                    // 保存数据
                    saveData('deviationData', deviationData);
                    
                    // 重新渲染列表
                    renderDeviationList();
                    
                    // 显示成功消息
                    document.getElementById('deviation-save-status').textContent = '保存成功';
                    document.getElementById('deviation-save-status').classList.remove('text-gray-500');
                    document.getElementById('deviation-save-status').classList.add('text-green-500');
                    
                    setTimeout(function() {
                        document.getElementById('deviation-save-status').textContent = '自动保存中...';
                        document.getElementById('deviation-save-status').classList.remove('text-green-500');
                        document.getElementById('deviation-save-status').classList.add('text-gray-500');
                    }, 2000);
                    
                    // 添加审计日志
                    addAuditLog(currentUser.username, 'update_deviation', `更新偏离记录 "${deviation.title}"`);
                }
            } else {
                // 添加新偏离记录
                const newDeviation = {
                    id: 'DEV' + Date.now().toString().slice(-6),
                    title,
                    content,
                    status,
                    createdBy: currentUser.username,
                    createdAt: today.toISOString(),
                    updatedAt: today.toISOString()
                };
                
                deviationData.deviations.push(newDeviation);
                
                // 保存数据
                saveData('deviationData', deviationData);
                
                // 重新渲染列表
                renderDeviationList();
                
                // 清空编辑器
                document.getElementById('deviation-title').value = '';
                document.getElementById('deviation-content').innerHTML = '';
                
                // 显示成功消息
                document.getElementById('deviation-save-status').textContent = '保存成功';
                document.getElementById('deviation-save-status').classList.remove('text-gray-500');
                document.getElementById('deviation-save-status').classList.add('text-green-500');
                
                setTimeout(function() {
                    document.getElementById('deviation-save-status').textContent = '自动保存中...';
                    document.getElementById('deviation-save-status').classList.remove('text-green-500');
                    document.getElementById('deviation-save-status').classList.add('text-gray-500');
                }, 2000);
                
                // 添加审计日志
                addAuditLog(currentUser.username, 'add_deviation', `添加新偏离记录 "${newDeviation.title}"`);
            }
        }

        // 删除偏离记录
        function deleteDeviation(deviationId) {
            const index = deviationData.deviations.findIndex(d => d.id === deviationId);
            
            if (index !== -1) {
                const deviation = deviationData.deviations[index];
                
                // 从数组中删除偏离记录
                deviationData.deviations.splice(index, 1);
                
                // 保存数据
                saveData('deviationData', deviationData);
                
                // 重新渲染列表
                renderDeviationList();
                
                // 如果当前正在编辑或查看被删除的偏离记录，清空编辑器
                if (currentDeviationId === deviationId) {
                    document.getElementById('deviation-title').value = '';
                    document.getElementById('deviation-content').innerHTML = '';
                    currentDeviationId = null;
                }
                
                // 显示成功消息
                alert('偏离记录已删除');
                
                // 添加审计日志
                addAuditLog(currentUser.username, 'delete_deviation', `删除偏离记录 "${deviation.title}"`);
            }
        }

        // 渲染用户列表
        function renderUserList() {
            const userListContainer = document.getElementById('user-list');
            userListContainer.innerHTML = '';
            
            userData.users.forEach(function(user) {
                // 确定状态标签样式
                let statusClass = '';
                let statusText = '';
                
                switch (user.isActive) {
                    case true:
                        statusClass = 'status-normal';
                        statusText = '活跃';
                        break;
                    case false:
                        statusClass = 'status-disabled';
                        statusText = '禁用';
                        break;
                }
                
                // 创建列表项
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.role === 'admin' ? '管理员' : '普通用户'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.lastLogin ? formatDateTime(new Date(user.lastLogin)) : '从未登录'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="flex items-center">
                            <span class="status-badge ${statusClass}"></span>
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end space-x-2">
                            ${user.username !== 'admin' ? `
                                <button class="edit-user-btn text-secondary hover:text-secondary-dark" data-id="${user.id}">
                                    编辑
                                </button>
                                <button class="toggle-user-btn text-warning hover:text-yellow-700" data-id="${user.id}">
                                    ${user.isActive ? '禁用' : '启用'}
                                </button>
                                <button class="delete-user-btn text-danger hover:text-red-700" data-id="${user.id}">
                                    删除
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                userListContainer.appendChild(row);
                
                // 绑定编辑按钮事件
                const editBtn = row.querySelector('.edit-user-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        openEditUserModal(userId);
                    });
                }
                
                // 绑定禁用/启用按钮事件
                const toggleBtn = row.querySelector('.toggle-user-btn');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        const user = userData.users.find(u => u.id === userId);
                        
                        if (user) {
                            const action = user.isActive ? '禁用' : '启用';
                            document.getElementById('delete-confirmation-message').textContent = `您确定要${action}用户 "${user.username}" 吗？`;
                            document.getElementById('confirm-delete-modal').classList.remove('hidden');
                            
                            deleteCallback = function() {
                                toggleUserStatus(userId);
                            };
                        }
                    });
                }
                
                // 绑定删除用户按钮事件
                const deleteBtn = row.querySelector('.delete-user-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        const user = userData.users.find(u => u.id === userId);
                        
                        if (user) {
                            document.getElementById('delete-confirmation-message').textContent = `您确定要彻底删除用户 "${user.username}" 吗？此操作不可恢复！`;
                            document.getElementById('confirm-delete-modal').classList.remove('hidden');
                            
                            deleteCallback = function() {
                                deleteUser(userId);
                            };
                        }
                    });
                }
            });
        }

        // 打开添加用户弹窗
        function openAddUserModal() {
            // 重置表单
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-modal-title').textContent = '添加账号';
            
            // 显示密码字段
            document.getElementById('password-field-container').classList.remove('hidden');
            document.getElementById('edit-password').required = true;
            
            // 显示弹窗
            document.getElementById('user-management-modal').classList.remove('hidden');
        }

        // 打开编辑用户弹窗
        function openEditUserModal(userId) {
            const user = userData.users.find(u => u.id === userId);
            
            if (!user) return;
            
            // 填充表单
            document.getElementById('user-id').value = user.id;
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-username').disabled = true; // 用户名不可修改
            document.getElementById('edit-role').value = user.role;
            document.getElementById('user-modal-title').textContent = '编辑账号';
            
            // 隐藏密码字段
            document.getElementById('password-field-container').classList.add('hidden');
            document.getElementById('edit-password').required = false;
            
            // 显示弹窗
            document.getElementById('user-management-modal').classList.remove('hidden');
        }

        // 保存用户
        function saveUser() {
            const userId = document.getElementById('user-id').value;
            const username = document.getElementById('edit-username').value;
            const password = document.getElementById('edit-password').value;
            const role = document.getElementById('edit-role').value;
            
            // 验证必填字段
            if (!username || !role) {
                alert('请填写所有必填字段');
                return;
            }
            
            // 添加新用户时验证密码
            if (!userId && !password) {
                alert('请输入密码');
                return;
            }
            
            // 验证用户名是否已存在（添加新用户时）
            if (!userId && userData.users.some(u => u.username === username)) {
                alert('用户名已存在');
                return;
            }
            
            if (userId) {
                // 编辑现有用户
                const user = userData.users.find(u => u.id === userId);
                
                if (user) {
                    user.role = role;
                    
                    // 如果提供了新密码，则更新密码
                    if (password) {
                        user.password = password;
                    }
                    
                    // 保存数据
                    saveData('userData', userData);
                    
                    // 重新渲染列表
                    renderUserList();
                    
                    // 关闭弹窗
                    document.getElementById('user-management-modal').classList.add('hidden');
                    
                    // 显示成功消息
                    alert('用户信息已更新');
                    
                    // 添加审计日志
                    addAuditLog(currentUser.username, 'update_user', `更新用户 ${user.username}`);
                }
            } else {
                // 添加新用户
                const newUser = {
                    id: 'USER' + Date.now().toString().slice(-6),
                    username,
                    password,
                    role,
                    lastLogin: null,
                    isActive: true
                };
                
                userData.users.push(newUser);
                
                // 保存数据
                saveData('userData', userData);
                
                // 重新渲染列表
                renderUserList();
                
                // 关闭弹窗
                document.getElementById('user-management-modal').classList.add('hidden');
                
                // 显示成功消息
                alert('用户已添加');
                
                // 添加审计日志
                addAuditLog(currentUser.username, 'add_user', `添加新用户 ${newUser.username}`);
            }
        }

        // 切换用户状态（启用/禁用）
        function toggleUserStatus(userId) {
            const user = userData.users.find(u => u.id === userId);
            
            if (user) {
                user.isActive = !user.isActive;
                
                // 保存数据
                saveData('userData', userData);
                
                // 重新渲染列表
                renderUserList();
                
                // 显示成功消息
                alert(`用户已${user.isActive ? '启用' : '禁用'}`);
                
                // 添加审计日志
                addAuditLog(currentUser.username, user.isActive ? 'enable_user' : 'disable_user', `${user.isActive ? '启用' : '禁用'}用户 ${user.username}`);
            }
        }
        
        // 删除用户
        function deleteUser(userId) {
            // 不允许删除管理员账号
            const user = userData.users.find(u => u.id === userId);
            if (user && user.username === 'admin') {
                alert('不允许删除管理员账号');
                return;
            }
            
            // 创建数据快照用于审计日志
            const userSnapshot = JSON.parse(JSON.stringify(userData));
            
            // 删除用户
            userData.users = userData.users.filter(u => u.id !== userId);
            
            // 保存数据
            saveData('userData', userData);
            
            // 重新渲染列表
            renderUserList();
            
            // 显示成功消息
            alert('用户已彻底删除');
            
            // 添加审计日志（包含数据快照）
            addAuditLog(currentUser.username, 'delete_user', `删除用户 ${user.username}`, userSnapshot);
        }

        // 查看审计日志详情
        function viewAuditDetails(logId) {
            const log = auditData.logs.find(l => l.id === logId);
            
            if (!log) return;
            
            // 填充详情
            document.getElementById('audit-details-timestamp').textContent = formatDateTime(new Date(log.timestamp));
            document.getElementById('audit-details-user').textContent = log.user;
            
            // 根据操作类型显示不同的操作名称
            let actionName = '';
            switch (log.action) {
                case 'login': actionName = '用户登录'; break;
                case 'logout': actionName = '用户退出'; break;
                case 'add_instrument': actionName = '添加仪器'; break;
                case 'update_instrument': actionName = '更新仪器'; break;
                case 'delete_instrument': actionName = '删除仪器'; break;
                case 'add_maintenance_record': actionName = '添加维护记录'; break;
                case 'update_maintenance_record': actionName = '更新维护记录'; break;
                case 'delete_maintenance_record': actionName = '删除维护记录'; break;
                case 'complete_maintenance': actionName = '一键完成维护'; break;
                case 'complete_record_maintenance': actionName = '完成维护记录'; break;
                case 'import_instruments': actionName = '导入仪器'; break;
                case 'export_instruments': actionName = '导出仪器'; break;
                case 'add_meeting': actionName = '添加会议纪要'; break;
                case 'update_meeting': actionName = '更新会议纪要'; break;
                case 'delete_meeting': actionName = '删除会议纪要'; break;
                case 'export_meetings': actionName = '导出会议纪要'; break;
                case 'add_deviation': actionName = '添加偏离记录'; break;
                case 'update_deviation': actionName = '更新偏离记录'; break;
                case 'delete_deviation': actionName = '删除偏离记录'; break;
                case 'add_user': actionName = '添加用户'; break;
                case 'update_user': actionName = '更新用户'; break;
                case 'toggle_user_status': actionName = '切换用户状态'; break;
                case 'change_password': actionName = '修改密码'; break;
                case 'system_start': actionName = '系统启动'; break;
                default: actionName = log.action;
            }
            
            document.getElementById('audit-details-action').textContent = actionName;
            document.getElementById('audit-details-details').textContent = log.details;
            
            // 显示或隐藏数据快照
            const snapshotContainer = document.getElementById('audit-details-snapshot-container');
            const snapshotContent = document.getElementById('audit-details-snapshot');
            
            if (log.dataSnapshot) {
                try {
                    const snapshot = JSON.parse(log.dataSnapshot);
                    snapshotContent.textContent = JSON.stringify(snapshot, null, 2);
                    snapshotContainer.classList.remove('hidden');
                } catch (e) {
                    snapshotContainer.error('Failed to parse data snapshot:', e);
                    snapshotContainer.classList.add('hidden');
                }
            } else {
                snapshotContainer.classList.add('hidden');
            }
            
            // 显示弹窗
            const modal = document.getElementById('audit-details-modal');
            modal.classList.remove('hidden');
            
            // 绑定关闭按钮事件
            document.getElementById('close-audit-details').addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            document.getElementById('audit-details-close').addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            // 点击外部关闭弹窗
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }
        
        // 确认回滚审计数据
        function confirmRollbackAuditData(logId) {
            const log = auditData.logs.find(l => l.id === logId);
            
            if (!log || !log.dataSnapshot) return;
            
            showModal('确认回滚', `您确定要回滚到 "${log.details}" 操作前的状态吗？此操作不可撤销。`, '确认', '取消', function() {
                rollbackAuditData(logId);
            });
        }
        
        // 回滚审计数据
        function rollbackAuditData(logId) {
            const log = auditData.logs.find(l => l.id === logId);
            
            if (!log || !log.dataSnapshot) return;
            
            try {
                const snapshot = JSON.parse(log.dataSnapshot);
                
                // 根据操作类型确定要回滚的数据
                switch (log.action) {
                    case 'add_instrument':
                    case 'update_instrument':
                    case 'delete_instrument':
                    case 'add_maintenance_record':
                    case 'update_maintenance_record':
                    case 'delete_maintenance_record':
                    case 'complete_maintenance':
                    case 'complete_record_maintenance':
                        // 回滚仪器数据
                        instrumentsData = JSON.parse(JSON.stringify(snapshot));
                        saveData('instrumentData', instrumentsData);
                        
                        // 重新渲染相关界面
                        renderDashboard();
                        renderInstrumentList();
                        break;
                        
                    case 'add_meeting':
                    case 'update_meeting':
                    case 'delete_meeting':
                        // 回滚会议纪要数据
                        meetingData = JSON.parse(JSON.stringify(snapshot));
                        saveData('meetingData', meetingData);
                        
                        // 重新渲染会议纪要列表
                        renderMeetingList();
                        break;
                        
                    case 'add_deviation':
                    case 'update_deviation':
                    case 'delete_deviation':
                        // 回滚偏离记录数据
                        deviationData = JSON.parse(JSON.stringify(snapshot));
                        saveData('deviationData', deviationData);
                        
                        // 重新渲染偏离记录列表
                        renderDeviationList();
                        break;
                        
                    case 'add_user':
                    case 'update_user':
                    case 'toggle_user_status':
                    case 'change_password':
                        // 回滚用户数据
                        userData = JSON.parse(JSON.stringify(snapshot));
                        saveData('userData', userData);
                        
                        // 重新渲染用户列表
                        renderUserList();
                        break;
                        
                    default:
                        // 不支持的回滚类型
                        showModal('提示', '不支持此类型操作的回滚。', '确定');
                        return;
                }
                
                // 显示成功消息
                showModal('回滚成功', '数据已成功回滚到操作前的状态。', '确定');
                
                // 添加审计日志
                addAuditLog(currentUser.username, 'rollback_data', `回滚操作: ${log.details}`);
                
                // 重新渲染审计日志
                renderAuditLogs();
                
            } catch (e) {
                console.error('Failed to rollback data:', e);
                showModal('回滚失败', '回滚数据时发生错误。', '确定');
            }
        }
        
        // 渲染审计日志
        function renderAuditLogs() {
            const searchTerm = document.getElementById('audit-search').value.toLowerCase();
            
            // 筛选日志
            let filteredLogs = auditData.logs;
            
            if (searchTerm) {
                filteredLogs = filteredLogs.filter(log => 
                    log.user.toLowerCase().includes(searchTerm) || 
                    log.action.toLowerCase().includes(searchTerm) || 
                    log.details.toLowerCase().includes(searchTerm)
                );
            }
            
            // 按时间排序
            filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // 渲染日志
            const auditLogsContainer = document.getElementById('audit-logs');
            auditLogsContainer.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                document.getElementById('no-audit-message').classList.remove('hidden');
                return;
            }
            
            document.getElementById('no-audit-message').classList.add('hidden');
            
            filteredLogs.forEach(function(log) {
                // 创建日志项
                const item = document.createElement('div');
                item.className = 'text-sm text-gray-700 border-b border-gray-200 pb-2';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-medium">${formatDateTime(new Date(log.timestamp))}</span>
                            <span class="text-gray-500 ml-2">${log.user}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="view-audit-details text-xs text-blue-600 hover:text-blue-800" data-id="${log.id}">
                                详情
                            </button>
                            ${log.dataSnapshot ? `
                                <button class="rollback-audit-data text-xs text-red-600 hover:text-red-800" data-id="${log.id}">
                                    回滚
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="mt-1">${log.details}</div>
                `;
                
                auditLogsContainer.appendChild(item);
                
                // 绑定详情按钮事件
                const viewDetailsBtn = item.querySelector('.view-audit-details');
                if (viewDetailsBtn) {
                    viewDetailsBtn.addEventListener('click', function() {
                        const logId = this.getAttribute('data-id');
                        viewAuditDetails(logId);
                    });
                }
                
                // 绑定回滚按钮事件
                const rollbackBtn = item.querySelector('.rollback-audit-data');
                if (rollbackBtn) {
                    rollbackBtn.addEventListener('click', function() {
                        const logId = this.getAttribute('data-id');
                        confirmRollbackAuditData(logId);
                    });
                }
            });
        }

        // 导出仪器信息
        function exportInstruments() {
            // 准备CSV数据
            let csvContent = "仪器编码,仪器名称,房间号,状态,维护类型,维护内容,维护周期(天),上次维护时间,下次维护时间\n";
            
            instrumentsData.instruments.forEach(function(instrument) {
                if (instrument.maintenanceRecords.length > 0) {
                    instrument.maintenanceRecords.forEach(function(record) {
                        const row = [
                            instrument.code,
                            instrument.name,
                            instrument.roomNumber,
                            instrument.status === 'normal' ? '正常' : instrument.status === 'maintenance' ? '维修中' : '停用',
                            record.type,
                            record.content,
                            record.cycle,
                            record.lastMaintenance || '',
                            record.nextMaintenance
                        ];
                        
                        csvContent += row.join(',') + '\n';
                    });
                } else {
                    const row = [
                        instrument.code,
                        instrument.name,
                        instrument.roomNumber,
                        instrument.status === 'normal' ? '正常' : instrument.status === 'maintenance' ? '维修中' : '停用',
                        '',
                        '',
                        '',
                        '',
                        ''
                    ];
                    
                    csvContent += row.join(',') + '\n';
                }
            });
            
            // 创建下载链接
            downloadCSV(csvContent, `仪器信息_${formatDate(new Date())}.csv`);
            
            // 添加审计日志
            addAuditLog(currentUser.username, 'export_instruments', '导出仪器信息');
        }

        // 导出会议纪要
        function exportMeetings() {
            // 准备CSV数据
            let csvContent = "主题,创建人,创建时间,更新时间,内容\n";
            
            meetingData.meetings.forEach(function(meeting) {
                const row = [
                    meeting.title,
                    meeting.createdBy,
                    formatDateTime(new Date(meeting.createdAt)),
                    formatDateTime(new Date(meeting.updatedAt)),
                    stripHtmlTags(meeting.content)
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // 创建下载链接
            downloadCSV(csvContent, `会议纪要_${formatDate(new Date())}.csv`);
            
            // 添加审计日志
            addAuditLog(currentUser.username, 'export_meetings', '导出会议纪要');
        }

        // 导出偏离记录
        function exportDeviations() {
            // 准备CSV数据
            let csvContent = "主题,状态,创建人,创建时间,更新时间,内容\n";
            
            deviationData.deviations.forEach(function(deviation) {
                const row = [
                    deviation.title,
                    deviation.status === 'pending' ? '待处理' : '已解决',
                    deviation.createdBy,
                    formatDateTime(new Date(deviation.createdAt)),
                    formatDateTime(new Date(deviation.updatedAt)),
                    stripHtmlTags(deviation.content)
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // 创建下载链接
            downloadCSV(csvContent, `偏离记录_${formatDate(new Date())}.csv`);
            
            // 添加审计日志
            addAuditLog(currentUser.username, 'export_deviations', '导出偏离记录');
        }

        // 下载CSV文件
        function downloadCSV(content, filename) {
            // 添加UTF-8 BOM头以解决中文乱码问题
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 添加审计日志
        function addAuditLog(user, action, details, dataSnapshot = null) {
            const newLog = {
                id: 'LOG' + Date.now().toString().slice(-6),
                user,
                action,
                details,
                timestamp: new Date().toISOString(),
                dataSnapshot: dataSnapshot ? JSON.stringify(dataSnapshot) : null
            };
            
            auditData.logs.push(newLog);
            
            // 限制日志数量，只保留最近的1000条
            if (auditData.logs.length > 1000) {
                auditData.logs = auditData.logs.slice(-1000);
            }
            
            // 保存数据
            saveData('auditData', auditData);
            
            // 如果当前在系统管理模块，更新日志显示
            if (currentModule === 'system') {
                renderAuditLogs();
            }
        }

        // 启动自动保存
        function startAutoSave(type) {
            // 停止之前的自动保存
            stopAutoSave();
            
            // 设置新的自动保存
            autoSaveInterval = setInterval(function() {
                if (type === 'meeting') {
                    const title = document.getElementById('meeting-title').value;
                    const content = document.getElementById('meeting-content').innerHTML;
                    
                    if (title && content) {
                        // 自动保存草稿
                        localStorage.setItem('meetingDraft', JSON.stringify({
                            title,
                            content,
                            timestamp: new Date().toISOString()
                        }));
                    }
                } else if (type === 'deviation') {
                    const title = document.getElementById('deviation-title').value;
                    const content = document.getElementById('deviation-content').innerHTML;
                    const status = document.getElementById('deviation-status').value;
                    
                    if (title && content) {
                        // 自动保存草稿
                        localStorage.setItem('deviationDraft', JSON.stringify({
                            title,
                            content,
                            status,
                            timestamp: new Date().toISOString()
                        }));
                    }
                }
            }, 30000); // 每30秒自动保存一次
        }

        // 停止自动保存
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        // 启动闲置计时器
        function startIdleTimer() {
            // 停止之前的计时器
            stopIdleTimer();
            
            // 设置新的计时器
            idleTimeout = setTimeout(function() {
                // 5分钟无操作，自动退出登录
                logout();
                alert('由于长时间未操作，您已被自动退出登录。');
            }, 300000); // 5分钟 = 300000毫秒
        }

        // 重置闲置计时器
        function resetIdleTimer() {
            if (idleTimeout) {
                clearTimeout(idleTimeout);
                startIdleTimer();
            }
        }

        // 停止闲置计时器
        function stopIdleTimer() {
            if (idleTimeout) {
                clearTimeout(idleTimeout);
                idleTimeout = null;
            }
        }

        // 保存数据到localStorage
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
            
            // 如果有LeanCloud同步实例，尝试同步到云端
            if (window.lcSync) {
                try {
                    // 根据数据类型触发不同的同步事件
                    switch (key) {
                        case 'instrumentData':
                            // 同步每个仪器
                            data.instruments.forEach(instrument => {
                                const event = new CustomEvent('lc:saveInstrument', {
                                    detail: { data: instrument }
                                });
                                document.dispatchEvent(event);
                            });
                            break;
                        case 'meetingData':
                            // 同步每个会议纪要
                            data.meetings.forEach(meeting => {
                                const event = new CustomEvent('lc:saveMeeting', {
                                    detail: { data: meeting }
                                });
                                document.dispatchEvent(event);
                            });
                            break;
                        case 'deviationData':
                            // 同步每个偏离记录
                            data.deviations.forEach(deviation => {
                                const event = new CustomEvent('lc:saveDeviation', {
                                    detail: { data: deviation }
                                });
                                document.dispatchEvent(event);
                            });
                            break;
                        case 'userData':
                            // 同步每个用户
                            data.users.forEach(user => {
                                const event = new CustomEvent('lc:saveUser', {
                                    detail: { data: user }
                                });
                                document.dispatchEvent(event);
                            });
                            break;
                        case 'auditData':
                            // 同步每个审计日志
                            data.logs.forEach(log => {
                                const event = new CustomEvent('lc:saveAuditLog', {
                                    detail: { data: log }
                                });
                                document.dispatchEvent(event);
                            });
                            break;
                    }
                } catch (error) {
                    console.error('同步数据到LeanCloud失败:', error);
                }
            }
        }

        // 从localStorage获取数据
        function getData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        // 格式化日期（YYYY-MM-DD）
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // 格式化日期时间（YYYY-MM-DD HH:MM:SS）
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 获取下个月的日期
        function getNextMonthDate(days = 30) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return formatDate(date);
        }

        // 获取下周的日期
        function getNextWeekDate() {
            const date = new Date();
            date.setDate(date.getDate() + 7);
            return formatDate(date);
        }

        // 获取三个月后的日期
        function getNextThreeMonthDate() {
            const date = new Date();
            date.setMonth(date.getMonth() + 3);
            return formatDate(date);
        }

        // 获取六个月后的日期
        function getNextSixMonthDate() {
            const date = new Date();
            date.setMonth(date.getMonth() + 6);
            return formatDate(date);
        }

        // 去除HTML标签
        function stripHtmlTags(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
        
        // 更新同步状态显示
        function updateSyncStatusDisplay() {
            if (window.lcSync && document.getElementById('sync-status')) {
                const syncStatus = lcSync.getSyncStatus();
                
                if (syncStatus.isSyncing) {
                    document.getElementById('sync-status').textContent = '同步中...';
                    document.getElementById('sync-status').classList.remove('text-green-500', 'text-red-500');
                    document.getElementById('sync-status').classList.add('text-warning');
                } else if (syncStatus.syncError) {
                    document.getElementById('sync-status').textContent = '同步失败';
                    document.getElementById('sync-status').classList.remove('text-warning', 'text-green-500');
                    document.getElementById('sync-status').classList.add('text-red-500');
                } else if (syncStatus.lastSyncTime) {
                    document.getElementById('sync-status').textContent = '已同步';
                    document.getElementById('sync-status').classList.remove('text-warning', 'text-red-500');
                    document.getElementById('sync-status').classList.add('text-green-500');
                } else {
                    document.getElementById('sync-status').textContent = '未同步';
                    document.getElementById('sync-status').classList.remove('text-warning', 'text-green-500');
                    document.getElementById('sync-status').classList.add('text-gray-500');
                }
            }
        }
        
        // 显示提示消息
        function showToast(message, type = 'success') {
            // 创建提示元素
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.textContent = message;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 淡入效果
            setTimeout(() => {
                toast.classList.add('opacity-90');
            }, 10);
            
            // 自动关闭
            setTimeout(() => {
                toast.classList.remove('opacity-90');
                toast.classList.add('opacity-0');
                
                // 移除元素
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // 监听LeanCloud同步完成事件
        document.addEventListener('lc:syncComplete', function(e) {
            console.log('数据同步完成，最后同步时间:', e.detail.lastSyncTime);
            
            // 更新同步状态显示
            updateSyncStatusDisplay();
            
            // 如果应用已初始化，重新渲染数据
            if (window.appInitialized) {
                initializeData();
                renderDashboard();
                renderInstrumentList();
                renderMeetingList();
                renderDeviationList();
                renderUserList();
                renderAuditLogs();
                
                // 显示成功提示
                showToast('数据同步成功');
            }
        });
        
        // 监听LeanCloud同步错误事件
        document.addEventListener('lc:syncError', function(e) {
            console.error('数据同步失败:', e.detail.error);
            
            // 更新同步状态显示
            updateSyncStatusDisplay();
            
            // 显示错误提示
            showToast('数据同步失败: ' + e.detail.error.message, 'error');
        });
        
        // 会议纪要和偏离管理弹窗相关事件绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 会议纪要弹窗
            const addMeetingBtn = document.getElementById('add-meeting-btn');
            const addMeetingModal = document.getElementById('add-meeting-modal');
            const closeAddMeeting = document.getElementById('close-add-meeting');
            
            if (addMeetingBtn && addMeetingModal && closeAddMeeting) {
                addMeetingBtn.addEventListener('click', function() {
                    // 清空编辑器内容
                    document.getElementById('meeting-title').value = '';
                    document.getElementById('meeting-content').innerHTML = '';
                    addMeetingModal.classList.remove('hidden');
                });
                
                closeAddMeeting.addEventListener('click', function() {
                    addMeetingModal.classList.add('hidden');
                });
            }
            
            // 偏离管理弹窗
            const addDeviationBtn = document.getElementById('add-deviation-btn');
            const addDeviationModal = document.getElementById('add-deviation-modal');
            const closeAddDeviation = document.getElementById('close-add-deviation');
            
            if (addDeviationBtn && addDeviationModal && closeAddDeviation) {
                addDeviationBtn.addEventListener('click', function() {
                    // 清空编辑器内容
                    document.getElementById('deviation-title').value = '';
                    document.getElementById('deviation-content').innerHTML = '';
                    document.getElementById('deviation-status').value = 'pending';
                    addDeviationModal.classList.remove('hidden');
                    
                    // 绑定编辑器按钮事件
                    addDeviationModal.querySelectorAll('.editor-btn').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            const command = this.getAttribute('data-command');
                            document.execCommand(command, false, null);
                            document.getElementById('deviation-content').focus();
                        });
                    });
                });
                
                closeAddDeviation.addEventListener('click', function() {
                    addDeviationModal.classList.add('hidden');
                });
            }
        });
    </script>


</body></html>